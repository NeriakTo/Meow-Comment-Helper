<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–µå—šè©•èªåŠ©æ‰‹ V4.0 (æ™‚å…‰å±‹ç‰ˆ)</title>
    <script src="config.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .input-focus { transition: all 0.3s ease; }
        .input-focus:focus { transform: scale(1.01); }
        /* æ¨¡æ…‹çª—éæ¸¡å‹•ç•« */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-orange-50 h-screen overflow-hidden text-slate-800">

<div id="app" class="flex h-full max-w-[1920px] mx-auto shadow-2xl relative">

    <transition name="fade">
        <div v-if="showClassManager" class="absolute inset-0 z-50 bg-orange-900/50 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full border-4 border-orange-200 overflow-hidden flex flex-col max-h-[90vh]">
                <div class="bg-orange-100 p-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-orange-800 flex items-center gap-2">
                        <span>ğŸ¡</span> è²“çª©ç®¡ç† (ç­ç´šåˆ‡æ›)
                    </h2>
                    <button @click="showClassManager = false" class="text-slate-400 hover:text-slate-600 text-2xl">âœ•</button>
                </div>

                <div class="p-6 overflow-y-auto flex-1">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <div v-for="(cls, id) in db.classes" :key="id" 
                             @click="switchClass(id)"
                             class="p-4 rounded-xl border-2 cursor-pointer transition-all relative group"
                             :class="db.activeClassId === id ? 'border-orange-500 bg-orange-50 ring-2 ring-orange-200' : 'border-slate-100 hover:border-orange-300'">
                            
                            <div class="font-bold text-lg text-slate-700">{{ cls.name }}</div>
                            <div class="text-xs text-slate-400 mt-1">{{ cls.students.length }} éš»å°è²“</div>
                            <div v-if="db.activeClassId === id" class="absolute top-2 right-2 text-orange-500 text-xs font-bold bg-white px-2 py-0.5 rounded-full border border-orange-200">ç•¶å‰</div>
                            
                            <button v-if="Object.keys(db.classes).length > 1" 
                                    @click.stop="deleteClass(id)"
                                    class="absolute bottom-2 right-2 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>

                    <div class="border-t border-slate-100 my-4"></div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h3 class="font-bold text-slate-600 mb-3 flex items-center gap-2">ğŸ†• å»ºç«‹æ–°ç­ç´š</h3>
                            <div class="flex gap-2 mb-2">
                                <input v-model="newClassName" type="text" placeholder="ä¾‹å¦‚ï¼š115å­¸å¹´ 601ç­" class="flex-1 px-3 py-2 border rounded-lg text-sm">
                            </div>
                            <div class="flex gap-2 items-center">
                                <span class="text-xs text-slate-400">äººæ•¸:</span>
                                <input v-model.number="newClassCount" type="number" min="1" max="50" class="w-16 px-2 py-1 border rounded-lg text-sm text-center">
                                <button @click="createNewClass" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white text-sm font-bold py-2 rounded-lg transition">å»ºç«‹</button>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 relative overflow-hidden group">
                            <h3 class="font-bold text-blue-800 mb-2 flex items-center gap-2">ğŸ“‚ åŒ¯å…¥èˆŠ Excel (æ™‚å…‰æ©Ÿ)</h3>
                            <p class="text-xs text-blue-600 mb-4 leading-relaxed">
                                å°‡ä¹‹å‰åŒ¯å‡ºçš„ xlsx æª”æ¡ˆæ‹–å…¥æˆ–é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œç³»çµ±æœƒè‡ªå‹•å»ºç«‹åŒ…å«èˆŠè³‡æ–™çš„æ–°ç­ç´šã€‚
                            </p>
                            <label class="block w-full bg-white border border-blue-200 text-blue-600 hover:bg-blue-600 hover:text-white text-center py-2 rounded-lg cursor-pointer transition text-sm font-bold shadow-sm">
                                é¸æ“‡æª”æ¡ˆåŒ¯å…¥
                                <input type="file" accept=".xlsx, .xls" class="hidden" @change="handleImportExcel">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </transition>
    
    <div class="w-80 bg-white border-r border-orange-100 flex flex-col z-10">
        <div class="p-5 bg-orange-400 text-white shadow-md z-20 relative overflow-hidden">
            <div class="relative z-10">
                <div class="flex items-center justify-between mb-1 cursor-pointer hover:bg-orange-500/50 rounded p-1 -ml-1 transition" @click="showClassManager = true">
                    <h1 class="text-lg font-bold tracking-wide flex items-center gap-1">
                        <span>ğŸ¡</span> {{ currentClassName }}
                    </h1>
                    <span class="text-xs bg-white/20 px-2 py-0.5 rounded text-white">åˆ‡æ› â–¼</span>
                </div>
                <div class="mt-3 relative">
                    <input type="text" v-model="searchQuery" 
                           placeholder="æœå°‹å°é­šä¹¾..." 
                           class="w-full pl-8 pr-3 py-1.5 text-slate-800 rounded-lg border-0 focus:ring-2 focus:ring-orange-200 shadow-sm text-sm placeholder-orange-300 bg-white/95">
                    <span class="absolute left-2.5 top-1.5 text-orange-300 text-xs">ğŸ”</span>
                </div>
            </div>
            <div class="absolute -right-4 -bottom-6 text-8xl opacity-10 rotate-12 select-none">ğŸ±</div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-3 space-y-2 no-scrollbar bg-orange-50/30">
            <div v-for="(student, index) in filteredStudents" :key="student.id" 
                 @click="selectStudent(student.originalIndex)"
                 class="group relative p-3 rounded-2xl cursor-pointer border transition-all duration-200 pr-8"
                 :class="currentIdx === student.originalIndex ? 'bg-white border-orange-300 shadow-md ring-2 ring-orange-100' : 'bg-white/60 border-transparent hover:bg-white hover:border-orange-200'">
                
                <div class="flex flex-col">
                    <span class="text-xs font-mono text-slate-400 mb-0.5 flex items-center gap-1">
                        <span class="text-[10px]">ğŸ¾</span> åº§è™Ÿ {{ student.id }}
                    </span>
                    <div class="flex items-center gap-2">
                        <span v-if="student.name" class="font-bold text-slate-700 text-lg">{{ student.name }}</span>
                        <span v-else class="text-slate-400 text-sm italic">(é»æ“Šè¼¸å…¥å§“å)</span>
                        
                        <span v-if="student.polished_comment" class="text-[10px] text-orange-600 font-bold bg-orange-100 px-2 py-0.5 rounded-full border border-orange-200">
                            âœ”
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-2 border-t border-orange-100 text-xs text-slate-400 text-center bg-white flex justify-between px-4">
            <span>{{ students.length }} éš»å°è²“</span>
            <button @click="resetCurrentClass" class="text-red-300 hover:text-red-500 hover:underline">æ¸…ç©ºæœ¬ç­</button>
        </div>
    </div>

    <div class="flex-1 flex flex-col h-full bg-white relative">
        <div class="h-16 bg-white border-b border-orange-50 flex items-center justify-between px-8 shadow-sm z-10">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold uppercase" :class="apiKey ? 'text-emerald-600' : 'text-red-500'">
                        {{ apiKey ? 'ç½ç½é‘°åŒ™ (OK)' : 'ç½ç½é‘°åŒ™ (æœªè¼¸å…¥)' }}
                    </span>
                    <input type="password" v-model="apiKey" :disabled="isConfigLoaded" 
                           placeholder="AIza..." 
                           class="bg-orange-50 border rounded-lg px-2 py-1 w-24 text-sm focus:w-64 transition-all focus:outline-none disabled:bg-slate-100 disabled:text-slate-400"
                           :class="!apiKey ? 'border-red-300 ring-2 ring-red-100' : 'border-orange-200 focus:border-orange-400'">
                </div>
                
                <div class="flex items-center gap-2 border-l pl-4 border-slate-100">
                    <span class="text-sm font-bold text-slate-600">é ˜åŸŸï¼š</span>
                    <select v-model="selectedSubject" class="bg-orange-50 border border-orange-200 text-slate-700 text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block p-1.5 font-bold cursor-pointer">
                        <option value="ä¸€èˆ¬å°å¸«">å°å¸« (ç­ç´šç¶“ç‡Ÿ)</option>
                        <option value="åœ‹èªæ–‡">åœ‹èªæ–‡</option>
                        <option value="æ•¸å­¸">æ•¸å­¸</option>
                        <option value="è‹±èªæ–‡">è‹±èªæ–‡</option>
                        <option value="è‡ªç„¶ç§‘å­¸">è‡ªç„¶ç§‘å­¸</option>
                        <option value="ç¤¾æœƒ">ç¤¾æœƒ</option>
                        <option value="è—è¡“">è—è¡“</option>
                        <option value="å¥åº·èˆ‡é«”è‚²">å¥é«”</option>
                        <option value="ç¶œåˆæ´»å‹•">ç¶œåˆ</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-3">
                <button @click="exportToExcel" class="flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-md transition-colors text-sm font-bold">
                    <span>ğŸŸ</span> åŒ¯å‡º Excel
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6 md:p-8 bg-orange-50/30" v-if="currentStudent">
            <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8 h-full">
                
                <div class="flex flex-col gap-4">
                    
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-orange-100 flex items-center gap-4 group hover:border-orange-300 transition-colors">
                        <div class="w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform select-none">
                            ğŸ±
                        </div>
                        <div class="flex-1">
                            <label class="text-xs font-bold text-slate-400 uppercase">å­¸ç”Ÿå§“å</label>
                            <input type="text" v-model="currentStudent.name" 
                                   placeholder="è¼¸å…¥åå­—..." 
                                   class="w-full text-2xl font-bold text-slate-800 border-b border-transparent focus:border-orange-400 focus:outline-none input-focus placeholder-slate-200 bg-transparent">
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-orange-100">
                        <div class="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider flex items-center gap-1">
                            <span>ğŸ¾</span> è²“è²“è§€å¯Ÿæ¨™ç±¤
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button v-for="tag in currentTags" :key="tag" @click="addTag(tag)"
                                    class="px-3 py-1 text-sm bg-slate-50 hover:bg-orange-100 hover:text-orange-700 text-slate-600 rounded-full transition-colors border border-slate-100">
                                {{ tag }}
                            </button>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col bg-white rounded-2xl shadow-sm border border-orange-100 overflow-hidden">
                        <div class="p-3 bg-orange-50/50 border-b border-orange-100 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 flex items-center gap-2">
                                <span>ğŸ“</span> è§€å¯Ÿç´€éŒ„
                            </h3>
                            <button @click="currentStudent.raw_comment = ''" class="text-xs text-slate-400 hover:text-red-500">æ¸…ç©º</button>
                        </div>
                        <textarea v-model="currentStudent.raw_comment" 
                                  class="flex-1 w-full p-5 resize-none focus:outline-none text-slate-700 leading-relaxed placeholder-slate-300 bg-transparent"
                                  placeholder="è«‹è¼¸å…¥è§€å¯Ÿç´€éŒ„ï¼Œè²“è²“æœƒå¹«ä½ æ½¤é£¾..."></textarea>
                    </div>
                </div>

                <div class="flex flex-col gap-4">
                    
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-2 border-orange-100 relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-orange-200 text-orange-800 text-xs px-3 py-1 rounded-bl-xl font-bold">â­ å…«å­—ç®´è¨€</div>
                        <div class="text-center py-2 flex items-center justify-center min-h-[3rem]">
                            <div v-if="currentStudent.motto" class="text-2xl font-bold text-orange-600 tracking-widest font-serif">
                                {{ currentStudent.motto }}
                            </div>
                            <div v-else class="text-slate-300 text-sm flex items-center gap-2">
                                <span>ğŸ¾</span> ç­‰å¾…è²“è²“è¸©å‡ºç®´è¨€...
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col bg-white rounded-2xl shadow-lg border border-orange-100 overflow-hidden relative ring-1 ring-orange-50">
                        <div class="p-3 bg-gradient-to-r from-orange-50 to-white border-b border-orange-100 flex justify-between items-center">
                            <h3 class="font-bold text-orange-800 flex items-center gap-2">
                                <span>âœ¨</span> æš–å¿ƒè©•èª
                            </h3>
                            <div class="flex gap-2">
                                <button v-if="currentStudent.polished_comment" @click="copyResult" class="text-xs text-orange-600 font-bold hover:bg-orange-100 px-2 py-1 rounded transition">è¤‡è£½</button>
                            </div>
                        </div>
                        
                        <textarea v-model="currentStudent.polished_comment" 
                                  class="flex-1 w-full p-6 resize-none focus:outline-none text-slate-800 leading-relaxed bg-white"
                                  placeholder="è²“è²“ç”Ÿæˆçš„å„ªç¾è©•èªå°‡é¡¯ç¤ºæ–¼æ­¤..."></textarea>

                        <div class="absolute bottom-6 right-6">
                            <button @click="generateComment" :disabled="isGenerating || !apiKey"
                                    class="flex items-center justify-center gap-2 px-6 py-3 rounded-full shadow-lg transition-all transform hover:scale-105 disabled:opacity-80 disabled:cursor-not-allowed disabled:transform-none text-white font-bold text-lg"
                                    :class="!apiKey ? 'bg-slate-400' : 'bg-gradient-to-r from-orange-400 to-amber-500 hover:from-orange-500 hover:to-amber-600'">
                                
                                <span v-if="!apiKey">ğŸš« ç¼ºç½ç½ (Key)</span>
                                <span v-else-if="isGenerating">ğŸ¾ è²“è²“æ€è€ƒä¸­...</span>
                                <span v-else>ğŸ¾ è²“è²“å¹«ä½ å¯«</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-else class="flex-1 flex flex-col items-center justify-center text-slate-300">
            <div class="text-8xl mb-4 opacity-30 grayscale cursor-pointer hover:scale-110 transition" @click="showClassManager=true">ğŸ˜½</div>
            <p class="text-xl font-medium text-slate-400">è«‹å…ˆé»æ“Šå·¦å´å°è²“ï¼Œæˆ–é»ä¸Šæ–¹åˆ‡æ›ç­ç´š</p>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, reactive, watch, onMounted, computed } = Vue;

    createApp({
        setup() {
            // ç³»çµ±è¨­å®š
            const apiKey = ref('');
            const isConfigLoaded = ref(false);
            const isGenerating = ref(false);
            const selectedSubject = ref('ä¸€èˆ¬å°å¸«');
            const searchQuery = ref('');
            
            // ç­ç´šç®¡ç†èˆ‡UIæ§åˆ¶
            const showClassManager = ref(false);
            const newClassName = ref('');
            const newClassCount = ref(30);

            // è³‡æ–™åº«æ ¸å¿ƒçµæ§‹ V4.0 (å¤šç­ç´š)
            const db = reactive({
                activeClassId: 'default',
                classes: {}
            });
            
            // ç‹€æ…‹èˆ‡æŒ‡é‡
            const currentIdx = ref(-1);

            // æ¨™ç±¤è³‡æ–™åº« (ç¶­æŒä¸è®Š)
            const tagsDB = {
                'ä¸€èˆ¬å°å¸«': ['ç†±å¿ƒåŠ©äºº', 'è² è²¬ç›¡è·', 'æ´»æ½‘å¤–å‘', 'äººç·£æ¥µä½³', 'æ²‰é»˜å¯¡è¨€', 'å°ˆæ³¨åŠ›ä½³', 'å®¹æ˜“åˆ†å¿ƒ', 'ä½œæ¥­å„ªè‰¯', 'éœ€åŠ å¼·æ•´æ½”', 'ç¦®è²Œå‘¨åˆ°', 'æ„›æƒœå…¬ç‰©', 'æ¨‚æ–¼åˆ†äº«'],
                'åœ‹èªæ–‡': ['å­—è·¡å·¥æ•´', 'å–œæ„›é–±è®€', 'æœ—è®€æµæš¢', 'èªæ„è¡¨é”ä½³', 'æˆèªé‹ç”¨è±å¯Œ', 'å¯«ä½œå…·å‰µæ„', 'å­—éŸ³å­—å½¢éœ€åŠ å¼·'],
                'æ•¸å­¸': ['é‚è¼¯æ¸…æ™°', 'è¨ˆç®—ç´°å¿ƒ', 'ç†è§£åŠ›å¼·', 'è§£é¡Œé€Ÿåº¦å¿«', 'ç²—å¿ƒå¤§æ„', 'ç©ºé–“æ¦‚å¿µä½³', 'é‹ç®—éœ€åŠ å¼·'],
                'è‹±èªæ–‡': ['ç™¼éŸ³æ¨™æº–', 'æ¨‚æ–¼é–‹å£', 'å–®å­—é‡è±å¯Œ', 'è½åŠ›æ•éŠ³', 'å‹‡æ–¼è¡¨é”', 'éœ€åŠ å¼·æ‹¼å­—'],
                'è—è¡“': ['å…·å‚™ç¾æ„Ÿ', 'å¯Œæœ‰å‰µæ„', 'è‰²å½©è±å¯Œ', 'ç·šæ¢å¤§è†½', 'æ­Œè²å„ªç¾', 'ç¯€å¥æ„Ÿå¼·', 'é‘‘è³èƒ½åŠ›ä½³'],
                'å¥åº·èˆ‡é«”è‚²': ['é«”èƒ½å„ªç•°', 'å”èª¿æ€§ä½³', 'åœ˜éšŠåˆä½œ', 'éµå®ˆè¦å‰‡', 'åæ‡‰éˆæ•', 'å±•ç¾é‹å‹•å®¶ç²¾ç¥'],
                'è‡ªç„¶ç§‘å­¸': ['è§€å¯Ÿå…¥å¾®', 'å‹‡æ–¼å¯¦é©—', 'å–œæ„›ç™¼å•', 'é‚è¼¯æ¨æ¼”', 'ç´€éŒ„è©³å¯¦'],
                'ç¤¾æœƒ': ['é—œæ‡·ç’°å¢ƒ', 'å…·å‚™åœ‹éš›è§€', 'å°Šé‡å¤šå…ƒ', 'æ¨‚æ–¼è¨è«–', 'å…·å‚™å…¬æ°‘ç´ é¤Š']
            };

            const MODEL_CANDIDATES = ['gemini-2.0-flash', 'gemini-2.5-flash', 'gemini-2.5-pro', 'gemini-flash-latest'];

            // Computed Properties
            const currentTags = computed(() => tagsDB[selectedSubject.value] || tagsDB['ä¸€èˆ¬å°å¸«']);
            
            // å–å¾—ç›®å‰ä½œç”¨ä¸­çš„ç­ç´šè³‡æ–™
            const currentClassData = computed(() => {
                if (!db.classes[db.activeClassId]) return { name: 'æœªçŸ¥ç­ç´š', students: [] };
                return db.classes[db.activeClassId];
            });
            
            const currentClassName = computed(() => currentClassData.value.name);
            const students = computed(() => currentClassData.value.students);

            const filteredStudents = computed(() => {
                if (!searchQuery.value) return students.value.map((s, i) => ({...s, originalIndex: i}));
                return students.value
                    .map((s, i) => ({...s, originalIndex: i}))
                    .filter(s => s.id.includes(searchQuery.value) || s.name.includes(searchQuery.value));
            });

            const currentStudent = computed(() => currentIdx.value !== -1 ? students.value[currentIdx.value] : null);

            // Life Cycle & Initialization
            onMounted(() => {
                // Key Logic
                if (window.APP_CONFIG && window.APP_CONFIG.GEMINI_API_KEY) {
                    apiKey.value = window.APP_CONFIG.GEMINI_API_KEY;
                    isConfigLoaded.value = true;
                } else {
                    const savedKey = localStorage.getItem('gemini_api_key');
                    if (savedKey) apiKey.value = savedKey;
                }

                // Database Migration Logic
                const savedDB = localStorage.getItem('gemini_comments_v4_db');
                if (savedDB) {
                    // å¦‚æœæœ‰ V4 è³‡æ–™ï¼Œç›´æ¥è®€å–
                    Object.assign(db, JSON.parse(savedDB));
                } else {
                    // å¦‚æœæ²’æœ‰ V4ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰ V3 è³‡æ–™é€²è¡Œé·ç§»
                    const v3Data = localStorage.getItem('gemini_comments_v3_data');
                    
                    const defaultClassId = 'class_' + Date.now();
                    db.activeClassId = defaultClassId;
                    
                    if (v3Data) {
                        // é·ç§»èˆŠè³‡æ–™
                        db.classes[defaultClassId] = {
                            name: 'åŒ¯å…¥çš„èˆŠç­ç´š',
                            students: JSON.parse(v3Data)
                        };
                        alert('å·²åµæ¸¬åˆ°èˆŠç‰ˆè³‡æ–™ï¼Œè²“è²“å·²è‡ªå‹•å¹«æ‚¨æ¬å®¶åˆ°ã€ŒåŒ¯å…¥çš„èˆŠç­ç´šã€å›‰ï¼ğŸ¾');
                    } else {
                        // å…¨æ–°åˆå§‹åŒ–
                        db.classes[defaultClassId] = {
                            name: 'é è¨­ç­ç´š',
                            students: []
                        };
                        showClassManager.value = true; // ç¬¬ä¸€æ¬¡ä¾†ï¼Œæ‰“é–‹ç®¡ç†ä»‹é¢
                    }
                }
            });

            // Persistence
            watch(db, (newVal) => {
                localStorage.setItem('gemini_comments_v4_db', JSON.stringify(newVal));
            }, { deep: true });
            
            watch(apiKey, (newVal) => { if (!isConfigLoaded.value) localStorage.setItem('gemini_api_key', newVal); });


            // Methods: Class Management
            const createNewClass = () => {
                if (!newClassName.value.trim()) { alert('è«‹å¹«è²“çª©å–å€‹åå­—ï¼'); return; }
                const newId = 'class_' + Date.now();
                
                // ç”¢ç”Ÿå­¸ç”Ÿç©ºæ®¼
                const newStudents = [];
                for (let i = 1; i <= newClassCount.value; i++) {
                    newStudents.push({
                        id: String(i).padStart(2, '0'),
                        name: '', raw_comment: '', polished_comment: '', motto: ''
                    });
                }

                db.classes[newId] = {
                    name: newClassName.value,
                    students: newStudents
                };
                
                // åˆ‡æ›éå»
                switchClass(newId);
                newClassName.value = '';
            };

            const switchClass = (id) => {
                db.activeClassId = id;
                currentIdx.value = -1; // é‡ç½®é¸å–
                // å¦‚æœè©²ç­ç´šæ²’äººï¼Œæç¤ºæ˜¯å¦è¦æ–°å¢
                if (db.classes[id].students.length === 0) {
                   // logic kept simple
                }
            };

            const deleteClass = (id) => {
                if (Object.keys(db.classes).length <= 1) { alert('è‡³å°‘è¦ä¿ç•™ä¸€å€‹è²“çª©å–”ï¼'); return; }
                if (confirm(`ç¢ºå®šè¦æ‹†é™¤ã€Œ${db.classes[id].name}ã€é€™å€‹è²“çª©å—ï¼Ÿè³‡æ–™æœƒæ¶ˆå¤±å–”ï¼`)) {
                    delete db.classes[id];
                    // å¦‚æœåˆªåˆ°ç•¶å‰ç­ç´šï¼Œåˆ‡æ›åˆ°ç¬¬ä¸€å€‹
                    if (db.activeClassId === id) {
                        db.activeClassId = Object.keys(db.classes)[0];
                        currentIdx.value = -1;
                    }
                }
            };

            // Excel Import Logic (V4 Core)
            const handleImportExcel = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });
                    const wsname = wb.SheetNames[0];
                    const ws = wb.Sheets[wsname];
                    const data = XLSX.utils.sheet_to_json(ws);

                    if (data.length === 0) { alert('Excel è£¡é¢æ²’æœ‰å°é­šä¹¾ (è³‡æ–™) å–”ï¼'); return; }

                    // è§£æè³‡æ–™ä¸¦æ˜ å°„å›æˆ‘å€‘çš„çµæ§‹
                    // å‡è¨­æ¬„ä½åç¨±ï¼šåº§è™Ÿ, å§“å, å…«å­—ç®´è¨€, æœŸæœ«è©•èª, åŸå§‹ç´€éŒ„
                    const importedStudents = data.map(row => ({
                        id: row['åº§è™Ÿ'] ? String(row['åº§è™Ÿ']).padStart(2, '0') : '00',
                        name: row['å§“å'] || '',
                        motto: row['å…«å­—ç®´è¨€'] || '',
                        polished_comment: row['æœŸæœ«è©•èª'] || '',
                        raw_comment: row['åŸå§‹ç´€éŒ„'] || ''
                    }));

                    // å»ºç«‹æ–°ç­ç´š
                    const newId = 'class_import_' + Date.now();
                    const fileName = file.name.replace('.xlsx', '').replace('.xls', '');
                    
                    db.classes[newId] = {
                        name: fileName, // ä½¿ç”¨æª”åç•¶ç­ç´šå
                        students: importedStudents
                    };

                    switchClass(newId);
                    alert(`æˆåŠŸæ¬é‹ ${importedStudents.length} éš»å°è²“åˆ°ã€Œ${fileName}ã€ï¼`);
                    showClassManager.value = false;
                };
                reader.readAsBinaryString(file);
                e.target.value = ''; // Reset input
            };


            // Methods: Student Operations
            const resetCurrentClass = () => {
                if (confirm('å–µï¼Ÿç¢ºå®šè¦æ¸…ç©ºæœ¬ç­æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) {
                    db.classes[db.activeClassId].students = [];
                    currentIdx.value = -1;
                }
            };

            const selectStudent = (index) => currentIdx.value = index;
            
            const addTag = (tag) => {
                if (currentStudent.value) {
                    const separator = currentStudent.value.raw_comment.length > 0 ? 'ã€' : '';
                    currentStudent.value.raw_comment += separator + tag;
                }
            };

            // AI Generation (Same as V3.1)
            const generateComment = async () => {
                if (!apiKey.value) { alert('è«‹è¼¸å…¥ç½ç½é‘°åŒ™ (API Key)'); return; }
                if (!currentStudent.value.name) { alert('è«‹å…ˆè¼¸å…¥å­¸ç”Ÿå§“å'); return; }
                if (!currentStudent.value.raw_comment) { alert('è«‹è¼¸å…¥è§€å¯Ÿç´€éŒ„'); return; }

                isGenerating.value = true;
                currentStudent.value.polished_comment = "ğŸ¾ è²“è²“æ­£åœ¨è¸©éµç›¤...";
                currentStudent.value.motto = "...";
                
                const prompt = `
                    è§’è‰²ï¼šå°ç£åœ‹å°ã€Œ${selectedSubject.value}ã€è€å¸«ã€‚
                    ä»»å‹™ï¼šç‚ºå­¸ç”Ÿã€Œ${currentStudent.value.name}ã€æ’°å¯«æœŸæœ«è©•èªèˆ‡å­¸ç±å¡å…«å­—ç®´è¨€ã€‚
                    æ ¼å¼ï¼šJSON output {"comment": "...", "motto": "..."}
                    è¦å‰‡ï¼š
                    1. ä¸»è©ã€Œ${currentStudent.value.name}ã€ã€‚
                    2. å­—æ•¸ 70-80 å­—ã€‚
                    3. èªæ°£æº«æš–è‚¯å®šã€‚
                    4. Motto ç‚ºå…©å€‹å››å­—æˆèªæˆ–å½¢å®¹è©çµ„ã€‚
                    
                    è§€å¯Ÿç´€éŒ„ï¼š${currentStudent.value.raw_comment}
                `;

                let success = false;
                for (const modelName of MODEL_CANDIDATES) {
                    try {
                        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey.value}`;
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        const data = await response.json();
                        if (data.error) throw new Error(data.error.message);
                        
                        if (data.candidates && data.candidates[0].content) {
                            let text = data.candidates[0].content.parts[0].text.trim();
                            text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                            const result = JSON.parse(text);
                            currentStudent.value.polished_comment = result.comment;
                            currentStudent.value.motto = result.motto;
                            success = true;
                            break;
                        }
                    } catch (e) { console.warn(e); }
                }

                if (!success) {
                    currentStudent.value.polished_comment = ""; 
                    currentStudent.value.motto = "";
                    alert('ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key æˆ–ç¶²è·¯ã€‚');
                }
                isGenerating.value = false;
            };

            const exportToExcel = () => {
                const ws = XLSX.utils.json_to_sheet(students.value.map(s => ({ 
                    'åº§è™Ÿ': s.id, 'å§“å': s.name, 'å…«å­—ç®´è¨€': s.motto,
                    'æœŸæœ«è©•èª': s.polished_comment, 'åŸå§‹ç´€éŒ„': s.raw_comment
                })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "è©•èªè¡¨");
                XLSX.writeFile(wb, `${currentClassName.value}_${selectedSubject.value}.xlsx`);
            };

            const copyResult = () => { navigator.clipboard.writeText(currentStudent.value.polished_comment); };

            return { 
                apiKey, isConfigLoaded, students, currentIdx, currentStudent, isGenerating, 
                searchQuery, filteredStudents, selectedSubject, currentTags, 
                // Class Manager Props
                db, showClassManager, newClassName, newClassCount, currentClassName,
                // Methods
                createNewClass, switchClass, deleteClass, handleImportExcel,
                resetCurrentClass, selectStudent, addTag, generateComment, exportToExcel, copyResult 
            };
        }
    }).mount('#app');
</script>
</body>
</html>