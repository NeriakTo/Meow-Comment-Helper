<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å–µå—šè©•èªåŠ©æ‰‹ V6.0</title>
    <script src="config.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .input-focus { transition: all 0.3s ease; }
        .input-focus:focus { transform: scale(1.01); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        /* æ‰‹æ©Ÿç‰ˆå´é‚Šæ¬„éæ¸¡å‹•ç•« */
        .slide-enter-active, .slide-leave-active { transition: transform 0.3s ease; }
        .slide-enter-from, .slide-leave-to { transform: translateX(-100%); }
    </style>
</head>
<body class="bg-orange-50 h-[100dvh] overflow-hidden text-slate-800">

<div id="app" class="flex h-full w-full relative">

    <transition name="fade">
        <div v-if="isSidebarOpen" @click="isSidebarOpen = false" class="fixed inset-0 bg-black/50 z-20 md:hidden"></div>
    </transition>

    <transition name="fade">
        <div v-if="showCloudModal" class="absolute inset-0 z-50 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full border-4 border-blue-200 overflow-hidden flex flex-col max-h-[90vh] overflow-y-auto">
                <div class="bg-blue-100 p-4 md:p-6 flex justify-between items-center">
                    <h2 class="text-xl md:text-2xl font-bold text-blue-800 flex items-center gap-2"><span>â˜ï¸</span> è²“è²“é›²ç«¯åŒæ­¥</h2>
                    <button @click="showCloudModal = false" class="text-slate-400 hover:text-slate-600 text-2xl">âœ•</button>
                </div>
                <div class="p-6 flex flex-col gap-6">
                    <div class="space-y-2">
                        <label class="text-sm font-bold text-slate-500 uppercase">æ‚¨çš„ Google Script ç¶²å€ (GAS URL)</label>
                        <input type="text" v-model="gasUrl" placeholder="è«‹è²¼ä¸Š https://script.google.com/.../exec" class="w-full p-3 border rounded-xl text-sm bg-slate-50 focus:ring-2 focus:ring-blue-300 outline-none transition-all" :class="gasUrl ? 'border-blue-300' : 'border-red-300'">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button @click="uploadToCloud" :disabled="!gasUrl || isSyncing" class="flex flex-col items-center justify-center p-4 rounded-xl border-2 border-blue-100 hover:bg-blue-50 hover:border-blue-300 transition gap-2 disabled:opacity-50"><span class="text-3xl">â¬†ï¸</span><span class="font-bold text-blue-700">ä¸Šå‚³å‚™ä»½</span></button>
                        <button @click="downloadFromCloud" :disabled="!gasUrl || isSyncing" class="flex flex-col items-center justify-center p-4 rounded-xl border-2 border-green-100 hover:bg-green-50 hover:border-green-300 transition gap-2 disabled:opacity-50"><span class="text-3xl">â¬‡ï¸</span><span class="font-bold text-green-700">ä¸‹è¼‰é‚„åŸ</span></button>
                    </div>
                    <div v-if="syncStatus" class="text-center text-sm font-bold p-3 rounded-xl transition-all" :class="syncStatus.includes('æˆåŠŸ') ? 'bg-green-100 text-green-700' : (syncStatus.includes('å¤±æ•—') ? 'bg-red-100 text-red-700' : 'bg-blue-50 text-blue-600')">{{ syncStatus }}</div>
                </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="showClassManager" class="absolute inset-0 z-50 bg-orange-900/50 backdrop-blur-sm flex items-center justify-center p-2 md:p-4">
            <div class="bg-white rounded-2xl md:rounded-3xl shadow-2xl w-full max-w-2xl border-4 border-orange-200 overflow-hidden flex flex-col max-h-[90vh]">
                <div class="bg-orange-100 p-4 md:p-6 flex justify-between items-center">
                    <h2 class="text-xl md:text-2xl font-bold text-orange-800 flex items-center gap-2"><span>ğŸ¡</span> è²“çª©ç®¡ç†</h2>
                    <button @click="showClassManager = false" class="text-slate-400 hover:text-slate-600 text-2xl">âœ•</button>
                </div>
                <div class="p-4 md:p-6 overflow-y-auto flex-1">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                        <div v-for="(cls, id) in db.classes" :key="id" @click="switchClass(id)"
                             class="p-4 rounded-xl border-2 cursor-pointer transition-all relative group"
                             :class="db.activeClassId === id ? 'border-orange-500 bg-orange-50 ring-2 ring-orange-200' : 'border-slate-100 hover:border-orange-300'">
                            <div class="font-bold text-lg text-slate-700">
                                {{ cls.grade }} å¹´ {{ cls.classNum }} ç­
                                <span class="text-sm font-normal text-slate-500 block md:inline">({{ cls.name || 'æœªå‘½å' }})</span>
                            </div>
                            <div class="text-xs text-slate-400 mt-1">{{ cls.students.length }} éš»å°è²“</div>
                            <div v-if="db.activeClassId === id" class="absolute top-2 right-2 text-orange-500 text-xs font-bold bg-white px-2 py-0.5 rounded-full border border-orange-200">ç•¶å‰</div>
                            <button v-if="Object.keys(db.classes).length > 1" @click.stop="deleteClass(id)" class="absolute bottom-2 right-2 text-slate-300 hover:text-red-500 md:opacity-0 group-hover:opacity-100 transition-opacity p-1">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div class="border-t border-slate-100 my-4"></div>
                    
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <h3 class="font-bold text-slate-600 mb-3">ğŸ†• å»ºç«‹æ–°ç­ç´š</h3>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div><label class="text-xs text-slate-400 block mb-1">å¹´ç´š (æ•¸å­—)</label><input v-model="newGrade" type="number" min="1" max="6" placeholder="å¦‚: 4" class="w-full px-3 py-2 border rounded-lg text-sm text-center font-bold"></div>
                            <div><label class="text-xs text-slate-400 block mb-1">ç­åº (æ•¸å­—)</label><input v-model="newClassNum" type="number" min="1" max="30" placeholder="å¦‚: 7" class="w-full px-3 py-2 border rounded-lg text-sm text-center font-bold"></div>
                        </div>
                        <div class="flex gap-2 items-center"><span class="text-xs text-slate-400 whitespace-nowrap">åˆ¥å:</span><input v-model="newClassName" type="text" placeholder="é¸å¡«" class="flex-1 px-3 py-2 border rounded-lg text-sm"></div>
                        <div class="flex gap-2 items-center mt-3"><span class="text-xs text-slate-400 whitespace-nowrap">äººæ•¸:</span><input v-model.number="newClassCount" type="number" min="1" max="50" class="w-16 px-2 py-1 border rounded-lg text-sm text-center"><button @click="createNewClass" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white text-sm font-bold py-2 rounded-lg transition">å»ºç«‹</button></div>
                    </div>
                    
                    <div class="mt-4 bg-blue-50 p-4 rounded-xl border border-blue-100 relative overflow-hidden group">
                        <h3 class="font-bold text-blue-800 mb-2">ğŸ“‚ åŒ¯å…¥èˆŠ Excel</h3>
                        <label class="block w-full bg-white border border-blue-200 text-blue-600 hover:bg-blue-600 hover:text-white text-center py-2 rounded-lg cursor-pointer transition text-sm font-bold shadow-sm">é¸æ“‡æª”æ¡ˆåŒ¯å…¥<input type="file" accept=".xlsx, .xls" class="hidden" @change="handleImportExcel"></label>
                    </div>
                </div>
            </div>
        </div>
    </transition>
    
    <div class="fixed md:relative z-30 h-full w-80 bg-white border-r border-orange-100 flex flex-col transition-transform duration-300 ease-in-out transform"
         :class="isSidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'">
        
        <div class="p-4 bg-orange-400 text-white shadow-md z-20 relative overflow-hidden shrink-0">
            <div class="relative z-10">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-1 cursor-pointer hover:bg-orange-500/50 rounded p-1 transition" @click="showClassManager = true">
                        <h1 class="text-lg font-bold tracking-wide">
                            <span v-if="currentClassData.grade">{{ currentClassData.grade }}å¹´{{ currentClassData.classNum }}ç­</span>
                            <span v-else>{{ currentClassData.name || 'é¸æ“‡ç­ç´š' }}</span>
                        </h1>
                        <span class="text-xs bg-white/20 px-2 py-0.5 rounded text-white">â–¼</span>
                    </div>
                    <button @click="isSidebarOpen = false" class="md:hidden text-white/80 hover:text-white text-xl font-bold p-1">âœ•</button>
                </div>
                <div class="relative">
                    <input type="text" v-model="searchQuery" placeholder="æœå°‹å§“å/åº§è™Ÿ..." class="w-full pl-8 pr-3 py-1.5 text-slate-800 rounded-lg border-0 focus:ring-2 focus:ring-orange-200 shadow-sm text-sm placeholder-orange-300 bg-white/95">
                    <span class="absolute left-2.5 top-1.5 text-orange-300 text-xs">ğŸ”</span>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-3 space-y-2 no-scrollbar bg-orange-50/30">
            <div v-for="(student, index) in filteredStudents" :key="student.id" @click="selectStudent(student.originalIndex)" 
                 class="group relative p-3 rounded-2xl cursor-pointer border transition-all duration-200 pr-8" 
                 :class="currentIdx === student.originalIndex ? 'bg-white border-orange-300 shadow-md ring-2 ring-orange-100' : 'bg-white/60 border-transparent hover:bg-white hover:border-orange-200'">
                <div class="flex flex-col">
                    <span class="text-xs font-mono text-slate-400 mb-0.5 flex items-center gap-1"><span class="text-[10px]">ğŸ¾</span> åº§è™Ÿ {{ student.id }}</span>
                    <div class="flex items-center gap-2">
                        <span v-if="student.name" class="font-bold text-slate-700 text-lg">{{ student.name }}</span>
                        <span v-else class="text-slate-400 text-sm italic">(é»æ“Šè¼¸å…¥)</span>
                        <span v-if="student.polished_comment" class="text-[10px] text-orange-600 font-bold bg-orange-100 px-2 py-0.5 rounded-full border border-orange-200">âœ”</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-2 border-t border-orange-100 text-xs text-slate-400 text-center bg-white flex justify-between px-4 shrink-0 safe-area-bottom">
            <span>{{ students.length }} éš»å°è²“</span>
            <button @click="resetCurrentClass" class="text-red-300 hover:text-red-500 hover:underline">æ¸…ç©ºæœ¬ç­</button>
        </div>
    </div>

    <div class="flex-1 flex flex-col h-full bg-white relative w-full overflow-hidden">
        <div class="bg-white border-b border-orange-50 flex flex-col md:flex-row items-start md:items-center justify-between p-3 md:px-8 shadow-sm z-10 gap-3 shrink-0">
            
            <div class="flex items-center w-full md:w-auto justify-between">
                <div class="flex items-center gap-2">
                    <button @click="isSidebarOpen = true" class="md:hidden p-2 -ml-2 text-slate-500 hover:bg-orange-50 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold uppercase whitespace-nowrap" :class="apiKey ? 'text-emerald-600' : 'text-red-500'">{{ apiKey ? 'ğŸ”‘ OK' : 'ğŸ”‘ æœªè¼¸å…¥' }}</span>
                        <input type="password" v-model="apiKey" :disabled="isConfigLoaded" placeholder="API Key..." class="bg-orange-50 border rounded-lg px-2 py-1 w-20 md:w-24 text-sm focus:w-64 transition-all focus:outline-none disabled:bg-slate-100" :class="!apiKey ? 'border-red-300' : 'border-orange-200'">
                    </div>
                </div>
                
                <div v-if="currentStudent" class="md:hidden font-bold text-slate-700 truncate max-w-[100px]">{{ currentStudent.name }}</div>
            </div>

            <div class="flex items-center justify-between w-full md:w-auto gap-3 overflow-x-auto no-scrollbar">
                <div class="flex items-center gap-2 md:border-l md:pl-4 border-slate-100 shrink-0">
                    <span class="text-sm font-bold text-slate-600 hidden md:inline">é ˜åŸŸï¼š</span>
                    <select v-model="selectedSubject" class="bg-orange-50 border border-orange-200 text-slate-700 text-sm rounded-lg focus:ring-orange-500 block p-1.5 font-bold cursor-pointer max-w-[120px]">
                        <option value="ä¸€èˆ¬å°å¸«">å°å¸« (ç­ç´šç¶“ç‡Ÿ)</option>
                        <option value="åœ‹èªæ–‡">åœ‹èªæ–‡</option>
                        <option value="æ•¸å­¸">æ•¸å­¸</option>
                        <option value="è‹±èªæ–‡">è‹±èªæ–‡</option>
                        <option value="è‡ªç„¶ç§‘å­¸">è‡ªç„¶ç§‘å­¸</option>
                        <option value="ç¤¾æœƒ">ç¤¾æœƒ</option>
                        <option value="è—è¡“">è—è¡“</option>
                        <option value="å¥åº·èˆ‡é«”è‚²">å¥é«”</option>
                        <option value="ç¶œåˆæ´»å‹•">ç¶œåˆ</option>
                    </select>
                </div>
                <div class="flex gap-2 shrink-0">
                    <button @click="showCloudModal = true" class="flex items-center gap-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg shadow transition text-sm font-bold">â˜ï¸ <span class="hidden sm:inline">åŒæ­¥</span></button>
                    <button @click="exportToExcel" class="flex items-center gap-1 bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-lg shadow transition text-sm font-bold">ğŸŸ <span class="hidden sm:inline">åŒ¯å‡º</span></button>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 bg-orange-50/30" v-if="currentStudent">
            <div class="max-w-6xl mx-auto pb-20 md:pb-0">
                <!-- V6.0: å­¸ç”Ÿå§“åå€å¡Š -->
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-orange-100 flex items-center gap-4 mb-4">
                    <div class="w-10 h-10 md:w-12 md:h-12 rounded-full bg-orange-100 flex items-center justify-center text-xl md:text-2xl select-none">ğŸ±</div>
                    <div class="flex-1">
                        <label class="text-xs font-bold text-slate-400 uppercase">å­¸ç”Ÿå§“å</label>
                        <input type="text" v-model="currentStudent.name" placeholder="è¼¸å…¥åå­—..." class="w-full text-xl md:text-2xl font-bold text-slate-800 border-b border-transparent focus:border-orange-400 focus:outline-none bg-transparent">
                    </div>
                </div>

                <!-- V6.0: Tabs å°èˆª -->
                <div class="bg-white rounded-2xl shadow-sm border border-orange-100 mb-4 overflow-hidden">
                    <div class="flex border-b border-orange-100 overflow-x-auto no-scrollbar">
                        <button @click="activeTab = 'comment'" 
                                class="flex-1 px-4 py-3 text-sm md:text-base font-bold transition-colors border-b-2"
                                :class="activeTab === 'comment' ? 'text-orange-600 border-orange-500 bg-orange-50' : 'text-slate-500 border-transparent hover:bg-orange-50/50'">
                            ğŸ“ è©•èªç”Ÿæˆ
                        </button>
                        <button @click="activeTab = 'behavior'" 
                                class="flex-1 px-4 py-3 text-sm md:text-base font-bold transition-colors border-b-2"
                                :class="activeTab === 'behavior' ? 'text-orange-600 border-orange-500 bg-orange-50' : 'text-slate-500 border-transparent hover:bg-orange-50/50'">
                            ğŸ“Š è¡Œç‚ºé‡è¡¨
                        </button>
                        <button @click="activeTab = 'records'" 
                                class="flex-1 px-4 py-3 text-sm md:text-base font-bold transition-colors border-b-2"
                                :class="activeTab === 'records' ? 'text-orange-600 border-orange-500 bg-orange-50' : 'text-slate-500 border-transparent hover:bg-orange-50/50'">
                            ğŸ† å¤šå…ƒç´€éŒ„
                        </button>
                    </div>

                    <!-- Tab 1: è©•èªç”Ÿæˆ -->
                    <div v-show="activeTab === 'comment'" class="p-4 md:p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                            <div class="flex flex-col gap-4">
                                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                    <div class="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider flex items-center gap-1"><span>ğŸ¾</span> å¿«é€Ÿæ¨™ç±¤</div>
                                    <div class="flex flex-wrap gap-2 max-h-32 overflow-y-auto">
                                        <button v-for="tag in currentTags" :key="tag" @click="addTag(tag)" class="px-2 py-1 md:px-3 text-xs md:text-sm bg-white hover:bg-orange-100 hover:text-orange-700 text-slate-600 rounded-full border border-slate-200 transition-colors">{{ tag }}</button>
                                    </div>
                                </div>
                                <div class="flex-1 flex flex-col bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden min-h-[200px]">
                                    <div class="p-3 bg-orange-50/50 border-b border-orange-100 flex justify-between items-center">
                                        <h3 class="font-bold text-slate-700 flex items-center gap-2 text-sm md:text-base"><span>ğŸ“</span> è§€å¯Ÿç´€éŒ„</h3>
                                        <button @click="currentStudent.raw_comment = ''" class="text-xs text-slate-400 hover:text-red-500">æ¸…ç©º</button>
                                    </div>
                                    <textarea v-model="currentStudent.raw_comment" class="flex-1 w-full p-4 resize-none focus:outline-none text-slate-700 leading-relaxed placeholder-slate-300 bg-transparent text-sm md:text-base" placeholder="è«‹è¼¸å…¥è§€å¯Ÿç´€éŒ„..."></textarea>
                                </div>
                            </div>
                            <div class="flex flex-col gap-4">
                                <div class="bg-white p-4 rounded-xl shadow-sm border-2 border-orange-100 relative overflow-hidden">
                                    <div class="absolute top-0 right-0 bg-slate-600 text-white text-[10px] md:text-xs px-2 py-1 rounded-bl-xl font-bold">å­¸ç±å¡è©•èª (åš´è¬¹)</div>
                                    <div class="text-center py-2 flex items-center justify-center min-h-[3rem]">
                                        <div v-if="currentStudent.motto" class="text-lg md:text-xl font-bold text-slate-700 tracking-widest font-serif">{{ currentStudent.motto }}</div>
                                        <div v-else class="text-slate-300 text-xs md:text-sm flex items-center gap-2"><span>âš–ï¸</span> ç­‰å¾…ç”Ÿæˆ...</div>
                                    </div>
                                </div>
                                <div class="flex-1 flex flex-col bg-white rounded-xl shadow-lg border border-orange-100 overflow-hidden relative ring-1 ring-orange-50 min-h-[250px]">
                                    <div class="p-3 bg-gradient-to-r from-orange-50 to-white border-b border-orange-100 flex justify-between items-center">
                                        <h3 class="font-bold text-orange-800 flex items-center gap-2 text-sm md:text-base"><span>âœ¨</span> å°å¸«è©•èª (æš–å¿ƒ)</h3>
                                        <button v-if="currentStudent.polished_comment" @click="copyResult" class="text-xs text-orange-600 font-bold hover:bg-orange-100 px-2 py-1 rounded transition">è¤‡è£½</button>
                                    </div>
                                    <textarea v-model="currentStudent.polished_comment" class="flex-1 w-full p-4 md:p-6 resize-none focus:outline-none text-slate-800 leading-relaxed bg-white text-sm md:text-base" placeholder="è²“è²“ç”Ÿæˆçš„æš–å¿ƒè©•èªå°‡é¡¯ç¤ºæ–¼æ­¤..."></textarea>
                                    <div class="absolute bottom-4 right-4 md:bottom-6 md:right-6 z-10">
                                        <button @click="generateComment" :disabled="isGenerating || !apiKey" 
                                                class="flex items-center justify-center gap-2 px-4 py-2 md:px-6 md:py-3 rounded-full shadow-xl transition-all transform active:scale-95 md:hover:scale-105 disabled:opacity-80 disabled:cursor-not-allowed disabled:transform-none text-white font-bold text-xs md:text-sm" 
                                                :class="!apiKey ? 'bg-slate-400' : 'bg-gradient-to-r from-orange-400 to-amber-500'">
                                            <span v-if="!apiKey">ğŸš« ç¼º Key</span>
                                            <span v-else-if="isGenerating">ğŸ¾ æ€è€ƒä¸­...</span>
                                            <span v-else>ğŸ¾ å¹«æˆ‘å¯«</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 2: è¡Œç‚ºé‡è¡¨ -->
                    <div v-show="activeTab === 'behavior'" class="p-4 md:p-6 overflow-y-auto max-h-[calc(100vh-300px)]">
                        <div class="mb-4 flex justify-between items-center">
                            <h3 class="text-lg md:text-xl font-bold text-slate-700">è¡Œç‚ºé‡è¡¨è©•ç­‰</h3>
                            <button @click="setDefaultBehavior" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold rounded-lg transition">
                                âš¡ ä¸€éµé è¨­ (å¤§éƒ¨åˆ†ç¬¦åˆ)
                            </button>
                        </div>
                        <div class="space-y-6" v-if="currentStudent.behavior">
                            <div v-for="(config, category) in BEHAVIOR_CONFIG" :key="category" class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 md:p-6">
                                <h4 class="text-base md:text-lg font-bold text-slate-700 mb-4 pb-2 border-b border-slate-200">ã€{{ category }}ã€‘</h4>
                                <div class="space-y-3 mb-4">
                                    <div v-for="(item, idx) in config.items" :key="idx" class="flex flex-col md:flex-row md:items-center gap-2">
                                        <label class="text-xs md:text-sm text-slate-600 flex-1 md:min-w-[300px]">{{ item }}</label>
                                        <select v-model="currentStudent.behavior[category].items[idx]" 
                                                class="px-3 py-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-orange-300 focus:border-orange-400 outline-none">
                                            <option value="">è«‹é¸æ“‡</option>
                                            <option v-for="opt in BEHAVIOR_OPTIONS" :key="opt" :value="opt">{{ opt }}</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-4 pt-4 border-t border-slate-200">
                                    <label class="text-sm font-bold text-slate-600 block mb-2">å…·é«”å»ºè­°ï¼š</label>
                                    <textarea v-model="currentStudent.behavior[category].suggestion" 
                                              placeholder="è«‹è¼¸å…¥å…·é«”å»ºè­°..." 
                                              class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm resize-none focus:ring-2 focus:ring-orange-300 focus:border-orange-400 outline-none"
                                              rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                        <div v-else class="text-center py-8 text-slate-400">
                            <p>æ­£åœ¨åˆå§‹åŒ–è¡Œç‚ºé‡è¡¨...</p>
                        </div>
                    </div>

                    <!-- Tab 3: å¤šå…ƒç´€éŒ„ -->
                    <div v-show="activeTab === 'records'" class="p-4 md:p-6 overflow-y-auto max-h-[calc(100vh-300px)]">
                        <h3 class="text-lg md:text-xl font-bold text-slate-700 mb-4">å¤šå…ƒè¡¨ç¾ç´€éŒ„</h3>
                        <div class="space-y-4" v-if="currentStudent.records">
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 md:p-6">
                                <label class="text-sm md:text-base font-bold text-slate-700 block mb-2">åœ˜é«”æ´»å‹•ç´€éŒ„</label>
                                <textarea v-model="currentStudent.records.groupActivity" 
                                          placeholder="è«‹è¼¸å…¥åœ˜é«”æ´»å‹•ç´€éŒ„..." 
                                          class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm resize-none focus:ring-2 focus:ring-orange-300 focus:border-orange-400 outline-none"
                                          rows="3"></textarea>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 md:p-6">
                                <label class="text-sm md:text-base font-bold text-slate-700 block mb-2">å…¬å…±æœå‹™ç´€éŒ„ - æ ¡å…§æœå‹™</label>
                                <textarea v-model="currentStudent.records.publicServiceSchool" 
                                          placeholder="è«‹è¼¸å…¥æ ¡å…§æœå‹™ç´€éŒ„..." 
                                          class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm resize-none focus:ring-2 focus:ring-orange-300 focus:border-orange-400 outline-none"
                                          rows="3"></textarea>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 md:p-6">
                                <label class="text-sm md:text-base font-bold text-slate-700 block mb-2">å…¬å…±æœå‹™ç´€éŒ„ - ç¤¾å€æœå‹™</label>
                                <textarea v-model="currentStudent.records.publicServiceCommunity" 
                                          placeholder="è«‹è¼¸å…¥ç¤¾å€æœå‹™ç´€éŒ„..." 
                                          class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm resize-none focus:ring-2 focus:ring-orange-300 focus:border-orange-400 outline-none"
                                          rows="3"></textarea>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 md:p-6">
                                <label class="text-sm md:text-base font-bold text-slate-700 block mb-2">æ ¡å…§å¤–ç‰¹æ®Šè¡¨ç¾ç´€éŒ„ - æ ¡å…§ç‰¹æ®Šè¡¨ç¾</label>
                                <textarea v-model="currentStudent.records.specialPerformanceSchool" 
                                          placeholder="è«‹è¼¸å…¥æ ¡å…§ç‰¹æ®Šè¡¨ç¾ç´€éŒ„..." 
                                          class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm resize-none focus:ring-2 focus:ring-orange-300 focus:border-orange-400 outline-none"
                                          rows="3"></textarea>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 md:p-6">
                                <label class="text-sm md:text-base font-bold text-slate-700 block mb-2">æ ¡å…§å¤–ç‰¹æ®Šè¡¨ç¾ç´€éŒ„ - æ ¡å¤–ç‰¹æ®Šè¡¨ç¾</label>
                                <textarea v-model="currentStudent.records.specialPerformanceExternal" 
                                          placeholder="è«‹è¼¸å…¥æ ¡å¤–ç‰¹æ®Šè¡¨ç¾ç´€éŒ„..." 
                                          class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm resize-none focus:ring-2 focus:ring-orange-300 focus:border-orange-400 outline-none"
                                          rows="3"></textarea>
                            </div>
                        </div>
                        <div v-else class="text-center py-8 text-slate-400">
                            <p>æ­£åœ¨åˆå§‹åŒ–å¤šå…ƒç´€éŒ„...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div v-else class="flex-1 flex flex-col items-center justify-center text-slate-300 p-8 text-center">
            <div class="text-6xl md:text-8xl mb-4 opacity-30 grayscale cursor-pointer hover:scale-110 transition" @click="isSidebarOpen = true">ğŸ˜½</div>
            <p class="text-lg md:text-xl font-medium text-slate-400">é»æ“Šå·¦ä¸Šè§’é¸å–®<br>é¸æ“‡ä¸€éš»å°è²“å§ï¼</p>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, reactive, watch, onMounted, computed } = Vue;

    createApp({
        setup() {
            // V5.2 RWD State
            const isSidebarOpen = ref(false); // æ§åˆ¶æ‰‹æ©Ÿå´é‚Šæ¬„

            // V5.1 State
            const newGrade = ref('');
            const newClassNum = ref('');
            const showCloudModal = ref(false);
            const gasUrl = ref('');
            const isSyncing = ref(false);
            const syncStatus = ref('');
            const apiKey = ref('');
            const isConfigLoaded = ref(false);
            const isGenerating = ref(false);
            const selectedSubject = ref('ä¸€èˆ¬å°å¸«');
            const searchQuery = ref('');
            const showClassManager = ref(false);
            const newClassName = ref('');
            const newClassCount = ref(30);
            const db = reactive({ activeClassId: 'default', classes: {} });
            const currentIdx = ref(-1);
            const activeTab = ref('comment'); // V6.0: Tab ç‹€æ…‹ ('comment', 'behavior', 'records')

            // ... (ç¶­æŒ V5.1 çš„ tagsDB, MODEL_CANDIDATES) ...
            const tagsDB = {
                'ä¸€èˆ¬å°å¸«': ['ç†±å¿ƒåŠ©äºº', 'è² è²¬ç›¡è·', 'æ´»æ½‘å¤–å‘', 'äººç·£æ¥µä½³', 'æ²‰é»˜å¯¡è¨€', 'å°ˆæ³¨åŠ›ä½³', 'å®¹æ˜“åˆ†å¿ƒ', 'ä½œæ¥­å„ªè‰¯', 'éœ€åŠ å¼·æ•´æ½”', 'ç¦®è²Œå‘¨åˆ°', 'æ„›æƒœå…¬ç‰©', 'æ¨‚æ–¼åˆ†äº«'],
                'åœ‹èªæ–‡': ['å­—è·¡å·¥æ•´', 'å–œæ„›é–±è®€', 'æœ—è®€æµæš¢', 'èªæ„è¡¨é”ä½³', 'æˆèªé‹ç”¨è±å¯Œ', 'å¯«ä½œå…·å‰µæ„', 'å­—éŸ³å­—å½¢éœ€åŠ å¼·'],
                'æ•¸å­¸': ['é‚è¼¯æ¸…æ™°', 'è¨ˆç®—ç´°å¿ƒ', 'ç†è§£åŠ›å¼·', 'è§£é¡Œé€Ÿåº¦å¿«', 'ç²—å¿ƒå¤§æ„', 'ç©ºé–“æ¦‚å¿µä½³', 'é‹ç®—éœ€åŠ å¼·'],
                'è‹±èªæ–‡': ['ç™¼éŸ³æ¨™æº–', 'æ¨‚æ–¼é–‹å£', 'å–®å­—é‡è±å¯Œ', 'è½åŠ›æ•éŠ³', 'å‹‡æ–¼è¡¨é”', 'éœ€åŠ å¼·æ‹¼å­—'],
                'è—è¡“': ['å…·å‚™ç¾æ„Ÿ', 'å¯Œæœ‰å‰µæ„', 'è‰²å½©è±å¯Œ', 'ç·šæ¢å¤§è†½', 'æ­Œè²å„ªç¾', 'ç¯€å¥æ„Ÿå¼·', 'é‘‘è³èƒ½åŠ›ä½³'],
                'å¥åº·èˆ‡é«”è‚²': ['é«”èƒ½å„ªç•°', 'å”èª¿æ€§ä½³', 'åœ˜éšŠåˆä½œ', 'éµå®ˆè¦å‰‡', 'åæ‡‰éˆæ•', 'å±•ç¾é‹å‹•å®¶ç²¾ç¥'],
                'è‡ªç„¶ç§‘å­¸': ['è§€å¯Ÿå…¥å¾®', 'å‹‡æ–¼å¯¦é©—', 'å–œæ„›ç™¼å•', 'é‚è¼¯æ¨æ¼”', 'ç´€éŒ„è©³å¯¦'],
                'ç¤¾æœƒ': ['é—œæ‡·ç’°å¢ƒ', 'å…·å‚™åœ‹éš›è§€', 'å°Šé‡å¤šå…ƒ', 'æ¨‚æ–¼è¨è«–', 'å…·å‚™å…¬æ°‘ç´ é¤Š']
            };
            const MODEL_CANDIDATES = ['gemini-2.0-flash', 'gemini-2.5-flash', 'gemini-2.5-pro', 'gemini-flash-latest'];
            
            // V6.0: è¡Œç‚ºé‡è¡¨é…ç½®
            const BEHAVIOR_CONFIG = {
                'æ•¬æ„›äºº': {
                    items: [
                        "1.å‹æ„›åŒå­¸ï¼Œå¹«åŠ©ä»–äººï¼Œæ›¿åˆ¥äººè‘—æƒ³",
                        "2.æ¥ç´å’Œå°Šé‡ä¸åŒæ–‡åŒ–çš„äºº",
                        "3.æ„Ÿè¬ç”Ÿæ´»ä¸­ç‚ºæˆ‘å€‘æœå‹™çš„äºº",
                        "4.è®šç¾ä»–äººï¼Œä¸¦å­¸ç¿’ä»–äººçš„é•·è™•",
                        "5.èª å¯¦é¢å°éŒ¯èª¤ï¼Œå‹‡æ–¼æ”¹æ­£"
                    ]
                },
                'æ„›æ•´æ½”': {
                    items: [
                        "1.é£¯å‰ä¾¿å¾Œæ´—æ‰‹ã€é£¯å¾Œæ½”ç‰™æ¼±å£",
                        "2.æ›¸åŒ…ã€æŠ½å±œå’Œæ•™å®¤ä¿æŒæ•´æ½”ï¼Œç‰©æ­¸å®šä½",
                        "3.ä¿æŒå„€å®¹æ•´æ½”ï¼Œå®šæœŸä¿®å‰ªæŒ‡ç”²",
                        "4.åƒåœ¾ä¸è½åœ°ï¼Œç¶­è­·æ ¡åœ’æ•´æ½”",
                        "5.æ­£ç¢ºä½¿ç”¨å»æ‰€ï¼Œä¿æŒæ•´æ½”"
                    ]
                },
                'å®ˆç§©åº': {
                    items: [
                        "1.éµå®ˆæ’éšŠåŠè¡Œé€²ç§©åº",
                        "2.ä¸å–§å˜©ã€å¥”è·‘ã€åšå±éšªå‹•ä½œåŠæ‹¿æ±è¥¿ä¸Ÿäºº",
                        "3.éµå®ˆç”¨é¤ç§©åºï¼Œä¸é‚Šèµ°é‚Šåƒ",
                        "4.æŒ‰æ™‚åˆ°æ ¡ï¼Œä¸Šèª²ä¸é²åˆ°",
                        "5.éµå®ˆå…¬ç‰©ä½¿ç”¨è¦å®šï¼Œä¸éš¨æ„ç ´å£"
                    ]
                },
                'æœ‰ç¦®è²Œ': {
                    items: [
                        "1.æœƒå‘å¸«é•·ã€ä¾†è³“åŠåŒå­¸å•å¥½",
                        "2.å¸¸èªªã€Œè«‹ã€è¬è¬ã€å°ä¸èµ·ã€",
                        "3.ä»”ç´°è†è½åˆ¥äººç™¼è¨€",
                        "4.è¨€è¡Œæœ‰ç¦®ï¼Œè¼•è²ç´°èªã€ä¸èªªç²—æš´çš„è©±",
                        "5.è™›å¿ƒæ¥å—å¸«é•·çš„æŒ‡å°"
                    ]
                },
                'åšç’°ä¿': {
                    items: [
                        "1.åšå¥½åƒåœ¾åˆ†é¡ã€åƒåœ¾æ¸›é‡",
                        "2.æ‡‚å¾—è³‡æºå›æ”¶å†åˆ©ç”¨",
                        "3.å­¸æ ¡åˆé¤ã€æˆ¶å¤–æ´»å‹•æ™‚ï¼Œè‡ªå‚™é¤å…·ç”¨é¤",
                        "4.ç¯€ç´„èƒ½æºï¼Œéš¨æ‰‹é—œç‡ˆã€é—œæ°´é¾é ­",
                        "5.æ„›ç‰©æƒœç‰©ï¼Œä¸æµªè²»è³‡æº"
                    ]
                }
            };
            const BEHAVIOR_OPTIONS = ['å®Œå…¨ç¬¦åˆ', 'å¤§éƒ¨åˆ†ç¬¦åˆ', 'éƒ¨åˆ†ç¬¦åˆ', 'å¾…æ”¹é€²'];

            // Computed
            const currentTags = computed(() => tagsDB[selectedSubject.value] || tagsDB['ä¸€èˆ¬å°å¸«']);
            const currentClassData = computed(() => db.classes[db.activeClassId] || { name: 'æœªçŸ¥ç­ç´š', students: [], grade: '', classNum: '' });
            const filteredStudents = computed(() => {
                const students = currentClassData.value.students || [];
                if (!searchQuery.value) return students.map((s, i) => ({...s, originalIndex: i}));
                return students.map((s, i) => ({...s, originalIndex: i})).filter(s => s.id.includes(searchQuery.value) || s.name.includes(searchQuery.value));
            });
            const students = computed(() => currentClassData.value.students || []);
            const currentStudent = computed(() => {
                if (currentIdx.value === -1) return null;
                const student = students.value[currentIdx.value];
                // V6.0: å¼·åˆ¶åˆå§‹åŒ–ç¢ºä¿ Vue Reactivity
                if (student) {
                    initializeStudentData(student);
                }
                return student;
            });

            // V6.0: å¼·åˆ¶åˆå§‹åŒ–å­¸ç”Ÿè³‡æ–™çµæ§‹ï¼ˆç¢ºä¿ Vue Reactivityï¼‰
            const initializeStudentData = (student) => {
                if (!student) return;
                
                // ç¢ºä¿ behavior ç‰©ä»¶å­˜åœ¨ä¸”å®Œæ•´
                if (!student.behavior) {
                    student.behavior = {};
                }
                Object.keys(BEHAVIOR_CONFIG).forEach(category => {
                    if (!student.behavior[category]) {
                        student.behavior[category] = {
                            items: BEHAVIOR_CONFIG[category].items.map(() => ''),
                            suggestion: ''
                        };
                    } else {
                        // ç¢ºä¿ items é™£åˆ—é•·åº¦æ­£ç¢º
                        if (!student.behavior[category].items || student.behavior[category].items.length !== BEHAVIOR_CONFIG[category].items.length) {
                            student.behavior[category].items = BEHAVIOR_CONFIG[category].items.map(() => '');
                        }
                        // ç¢ºä¿ suggestion å­˜åœ¨
                        if (student.behavior[category].suggestion === undefined) {
                            student.behavior[category].suggestion = '';
                        }
                    }
                });
                
                // ç¢ºä¿ records ç‰©ä»¶å­˜åœ¨ä¸”å®Œæ•´
                if (!student.records) {
                    student.records = {
                        groupActivity: '',
                        publicServiceSchool: '',
                        publicServiceCommunity: '',
                        specialPerformanceSchool: '',
                        specialPerformanceExternal: ''
                    };
                } else {
                    // ç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½å­˜åœ¨
                    if (student.records.groupActivity === undefined) student.records.groupActivity = '';
                    if (student.records.publicServiceSchool === undefined) student.records.publicServiceSchool = '';
                    if (student.records.publicServiceCommunity === undefined) student.records.publicServiceCommunity = '';
                    if (student.records.specialPerformanceSchool === undefined) student.records.specialPerformanceSchool = '';
                    if (student.records.specialPerformanceExternal === undefined) student.records.specialPerformanceExternal = '';
                }
                
                return student;
            };

            onMounted(() => {
                if (window.APP_CONFIG) {
                    if (window.APP_CONFIG.GEMINI_API_KEY) { apiKey.value = window.APP_CONFIG.GEMINI_API_KEY; isConfigLoaded.value = true; }
                    if (window.APP_CONFIG.GAS_URL) { gasUrl.value = window.APP_CONFIG.GAS_URL; }
                } else {
                    const savedKey = localStorage.getItem('gemini_api_key');
                    if (savedKey) apiKey.value = savedKey;
                    const savedGas = localStorage.getItem('gemini_gas_url');
                    if (savedGas) gasUrl.value = savedGas;
                }
                const savedDB = localStorage.getItem('gemini_comments_v4_db');
                if (savedDB) {
                    const parsed = JSON.parse(savedDB);
                    // V6.0: å¼·åˆ¶åˆå§‹åŒ–æ‰€æœ‰å­¸ç”Ÿçš„è³‡æ–™çµæ§‹ï¼ˆç¢ºä¿ Vue Reactivityï¼‰
                    Object.keys(parsed.classes || {}).forEach(classId => {
                        if (parsed.classes[classId].students) {
                            parsed.classes[classId].students.forEach(student => {
                                initializeStudentData(student);
                            });
                        }
                    });
                    Object.assign(db, parsed);
                    // V6.0: å¼·åˆ¶è§¸ç™¼ä¸€æ¬¡æ›´æ–°ï¼Œç¢ºä¿æ‰€æœ‰è³‡æ–™éƒ½æ˜¯ reactive
                    db.activeClassId = db.activeClassId;
                } else {
                    showClassManager.value = true;
                }
            });

            watch(db, (newVal) => localStorage.setItem('gemini_comments_v4_db', JSON.stringify(newVal)), { deep: true });
            watch(apiKey, (newVal) => { if (!isConfigLoaded.value) localStorage.setItem('gemini_api_key', newVal); });
            watch(gasUrl, (newVal) => localStorage.setItem('gemini_gas_url', newVal));

            // Methods
            const selectStudent = (index) => {
                currentIdx.value = index;
                isSidebarOpen.value = false; // æ‰‹æ©Ÿç‰ˆï¼šé¸æ“‡å­¸ç”Ÿå¾Œè‡ªå‹•æ”¶èµ·å´é‚Šæ¬„
            };

            const uploadToCloud = async () => {
                isSyncing.value = true; syncStatus.value = 'â˜ï¸ ä¸Šå‚³ä¸­...';
                try {
                    const response = await fetch(gasUrl.value, { method: 'POST', body: JSON.stringify(db) });
                    const res = await response.json();
                    if (res.result === 'success') syncStatus.value = `âœ… æˆåŠŸ! (${new Date().toLocaleTimeString()})`;
                    else throw new Error(res.error);
                } catch (e) { syncStatus.value = 'âŒ å¤±æ•—:' + e.message; } finally { isSyncing.value = false; }
            };
            const downloadFromCloud = async () => {
                if (!confirm('è¦†è“‹æœ¬æ©Ÿè³‡æ–™ï¼Ÿ')) return;
                isSyncing.value = true; syncStatus.value = 'â˜ï¸ ä¸‹è¼‰ä¸­...';
                try {
                    const response = await fetch(gasUrl.value);
                    const cloudData = await response.json();
                    if (cloudData && cloudData.classes) { Object.assign(db, cloudData); syncStatus.value = `âœ… é‚„åŸæˆåŠŸï¼`; currentIdx.value = -1; showClassManager.value = true; }
                    else throw new Error('è³‡æ–™éŒ¯èª¤');
                } catch (e) { syncStatus.value = 'âŒ å¤±æ•—:' + e.message; } finally { isSyncing.value = false; }
            };

            // V6.0: åˆå§‹åŒ–å­¸ç”Ÿè¡Œç‚ºè³‡æ–™çµæ§‹
            const initStudentBehavior = () => {
                const behavior = {};
                const records = {
                    groupActivity: '',
                    publicServiceSchool: '',
                    publicServiceCommunity: '',
                    specialPerformanceSchool: '',
                    specialPerformanceExternal: ''
                };
                Object.keys(BEHAVIOR_CONFIG).forEach(category => {
                    behavior[category] = {
                        items: BEHAVIOR_CONFIG[category].items.map(() => ''),
                        suggestion: ''
                    };
                });
                return { behavior, records };
            };

            const createNewClass = () => {
                if (!newGrade.value || !newClassNum.value) { alert('è«‹è¼¸å…¥å¹´ç´šèˆ‡ç­ç´š'); return; }
                const newId = 'class_' + Date.now();
                const newStudents = Array.from({length: newClassCount.value}, (_, i) => {
                    const { behavior, records } = initStudentBehavior();
                    const student = {
                        id: String(i+1).padStart(2,'0'), 
                        name:'', 
                        raw_comment:'', 
                        polished_comment:'', 
                        motto:'',
                        behavior: behavior,
                        records: records
                    };
                    // V6.0: å¼·åˆ¶åˆå§‹åŒ–ç¢ºä¿ Vue Reactivity
                    initializeStudentData(student);
                    return student;
                });
                db.classes[newId] = { 
                    name: newClassName.value || `${newGrade.value}å¹´${newClassNum.value}ç­`, 
                    grade: String(newGrade.value), classNum: String(newClassNum.value), students: newStudents 
                };
                switchClass(newId); newClassName.value = ''; newGrade.value = ''; newClassNum.value = '';
            };
            const switchClass = (id) => { db.activeClassId = id; currentIdx.value = -1; isSidebarOpen.value = false; }; // åˆ‡æ›ç­ç´šå¾Œé—œé–‰é¸å–®
            const deleteClass = (id) => { if (Object.keys(db.classes).length <= 1) return; if(confirm('åˆªé™¤ï¼Ÿ')) { delete db.classes[id]; if (db.activeClassId === id) { db.activeClassId = Object.keys(db.classes)[0]; currentIdx.value = -1; } } };
            
            const handleImportExcel = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const wb = XLSX.read(evt.target.result, { type: 'binary' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(ws);
                    let detectedGrade = ''; let detectedClassNum = '';
                    if (data.length > 0) {
                        if (data[0]['å¹´ç´š']) detectedGrade = String(data[0]['å¹´ç´š']);
                        if (data[0]['ç­ç´š']) detectedClassNum = String(data[0]['ç­ç´š']);
                    }
                    const importedStudents = data.map(row => {
                        const { behavior, records } = initStudentBehavior();
                        // V6.0: åŒ¯å…¥è¡Œç‚ºé‡è¡¨è³‡æ–™
                        Object.keys(BEHAVIOR_CONFIG).forEach(category => {
                            BEHAVIOR_CONFIG[category].items.forEach((item, idx) => {
                                const colName = `[${category}]${item}`;
                                if (row[colName]) behavior[category].items[idx] = row[colName];
                            });
                            const suggestionCol = `[${category}]å…·é«”å»ºè­°`;
                            if (row[suggestionCol]) behavior[category].suggestion = row[suggestionCol];
                        });
                        // V6.0: åŒ¯å…¥å¤šå…ƒç´€éŒ„
                        if (row['åœ˜é«”æ´»å‹•ç´€éŒ„']) records.groupActivity = row['åœ˜é«”æ´»å‹•ç´€éŒ„'];
                        if (row['å…¬å…±æœå‹™ç´€éŒ„-æ ¡å…§æœå‹™']) records.publicServiceSchool = row['å…¬å…±æœå‹™ç´€éŒ„-æ ¡å…§æœå‹™'];
                        if (row['å…¬å…±æœå‹™ç´€éŒ„-ç¤¾å€æœå‹™']) records.publicServiceCommunity = row['å…¬å…±æœå‹™ç´€éŒ„-ç¤¾å€æœå‹™'];
                        if (row['æ ¡å…§å¤–ç‰¹æ®Šè¡¨ç¾ç´€éŒ„-æ ¡å…§ç‰¹æ®Šè¡¨ç¾']) records.specialPerformanceSchool = row['æ ¡å…§å¤–ç‰¹æ®Šè¡¨ç¾ç´€éŒ„-æ ¡å…§ç‰¹æ®Šè¡¨ç¾'];
                        if (row['æ ¡å…§å¤–ç‰¹æ®Šè¡¨ç¾ç´€éŒ„-æ ¡å¤–ç‰¹æ®Šè¡¨ç¾']) records.specialPerformanceExternal = row['æ ¡å…§å¤–ç‰¹æ®Šè¡¨ç¾ç´€éŒ„-æ ¡å¤–ç‰¹æ®Šè¡¨ç¾'];
                        const student = {
                            id: row['åº§è™Ÿ'] ? String(row['åº§è™Ÿ']).padStart(2, '0') : '00',
                            name: row['å§“å'] || '', 
                            motto: row['å­¸ç±å¡å°å¸«è©•èª'] || row['å…«å­—ç®´è¨€'] || '',
                            polished_comment: row['å­¸æœŸæˆç¸¾å–®å°å¸«è©•èª'] || row['æœŸæœ«è©•èª'] || '', 
                            raw_comment: row['åŸå§‹ç´€éŒ„'] || '',
                            behavior: behavior,
                            records: records
                        };
                        // V6.0: å¼·åˆ¶åˆå§‹åŒ–ç¢ºä¿ Vue Reactivity
                        initializeStudentData(student);
                        return student;
                    });
                    const newId = 'class_import_' + Date.now();
                    let className = file.name.replace(/\.[^/.]+$/, "");
                    if (detectedGrade && detectedClassNum) className = `${detectedGrade}å¹´${detectedClassNum}ç­ (åŒ¯å…¥)`;
                    db.classes[newId] = { name: className, grade: detectedGrade, classNum: detectedClassNum, students: importedStudents };
                    switchClass(newId); showClassManager.value = false;
                    alert(detectedGrade ? `åŒ¯å…¥æˆåŠŸï¼${detectedGrade}å¹´${detectedClassNum}ç­ã€‚` : 'åŒ¯å…¥æˆåŠŸï¼è«‹æ‰‹å‹•è¨­å®šå¹´ç´šã€‚');
                };
                reader.readAsBinaryString(file); e.target.value = '';
            };
            
            const resetCurrentClass = () => { if(confirm('æ¸…ç©ºï¼Ÿ')) { db.classes[db.activeClassId].students = []; currentIdx.value = -1; } };
            const addTag = (tag) => { if (currentStudent.value) currentStudent.value.raw_comment += (currentStudent.value.raw_comment ? 'ã€' : '') + tag; };
            
            // V6.0: ä¸€éµé è¨­è¡Œç‚ºé‡è¡¨
            const setDefaultBehavior = () => {
                if (!currentStudent.value) return;
                // V6.0: å¼·åˆ¶åˆå§‹åŒ–ç¢ºä¿ Vue Reactivity
                initializeStudentData(currentStudent.value);
                Object.keys(BEHAVIOR_CONFIG).forEach(category => {
                    BEHAVIOR_CONFIG[category].items.forEach((_, idx) => {
                        currentStudent.value.behavior[category].items[idx] = 'å¤§éƒ¨åˆ†ç¬¦åˆ';
                    });
                });
                // V6.0: å¼·åˆ¶è§¸ç™¼æ›´æ–°
                db.activeClassId = db.activeClassId;
            };

            const generateComment = async () => {
                if (!apiKey.value) { alert('è«‹è¼¸å…¥ Key'); return; }
                if (!currentStudent.value.name) { alert('è«‹è¼¸å…¥å§“å'); return; }
                if (!currentStudent.value.raw_comment) { alert('è«‹è¼¸å…¥ç´€éŒ„'); return; }
                isGenerating.value = true; currentStudent.value.polished_comment = "ğŸ¾ æ€è€ƒä¸­...";
                const prompt = `è§’è‰²ï¼šå°ç£åœ‹å°ã€Œ${selectedSubject.value}ã€è€å¸«ã€‚ä»»å‹™ï¼šç‚ºå­¸ç”Ÿã€Œ${currentStudent.value.name}ã€æ’°å¯«å…©ä»½è©•èªã€‚è§€å¯Ÿç´€éŒ„ï¼š${currentStudent.value.raw_comment}ã€‚è«‹åš´æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¼¸å‡ºï¼š{"comment": "å­¸æœŸæˆç¸¾å–®è©•èª (æš–å¿ƒ)", "motto": "å­¸ç±å¡å…«å­—ç®´è¨€ (åš´è¬¹)"}ã€‚è¦å‰‡1(comment)ï¼š70-80å­—ï¼Œæº«æš–è‚¯å®šï¼ŒèåˆSELã€‚è¦å‰‡2(motto)ï¼šå…©å€‹å››å­—è©èªï¼Œä¸­é–“å…¨å½¢é€—è™Ÿéš”é–‹ã€‚ä¾æ“šè§€å¯Ÿç´€éŒ„çœŸå¯¦æ€§ï¼Œçµ¦äºˆã€Œå…©å¥½ã€ã€ã€Œä¸€å¥½ä¸€å£ã€æˆ–ã€Œå…©å£ã€ã€‚`;
                let success = false;
                for (const model of MODEL_CANDIDATES) {
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey.value}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        const data = await res.json();
                        if (data.candidates) {
                            let text = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                            const result = JSON.parse(text);
                            currentStudent.value.polished_comment = result.comment; currentStudent.value.motto = result.motto;
                            success = true; break;
                        }
                    } catch (e) {}
                }
                if (!success) alert('ç”Ÿæˆå¤±æ•—');
                isGenerating.value = false;
            };

            const exportToExcel = () => {
                // V6.0: å¼·åˆ¶è§¸ç™¼è³‡æ–™åŒæ­¥ï¼Œç¢ºä¿è®€å–æœ€æ–°è³‡æ–™
                // é€éè®€å– db ç‰©ä»¶å¼·åˆ¶è§¸ç™¼ Vue çš„ reactive æ›´æ–°
                const _ = JSON.stringify(db);
                
                const cls = currentClassData.value;
                const grade = cls.grade || 'æœªè¨­å®š'; 
                const classNum = cls.classNum || 'æœªè¨­å®š';
                
                // V6.0: å¼·åˆ¶åˆå§‹åŒ–æ‰€æœ‰å­¸ç”Ÿè³‡æ–™ï¼ˆç¢ºä¿è³‡æ–™å®Œæ•´æ€§ï¼‰
                const processedStudents = students.value.map(s => {
                    initializeStudentData(s);
                    return s;
                });
                
                // V6.0: å»ºç«‹é›™å±¤è¡¨é ­é™£åˆ—
                const ws_data = [];
                
                // Row 0: å¤§åˆ†é¡è¡¨é ­
                const row0 = [
                    'â€»å¹´ç´š', 'â€»ç­ç´šç·¨è™Ÿ', 'â€»åº§è™Ÿ', 'â€»å§“å',  // Col A-D (0-3)
                    'â€»æ•¬æ„›äºº', '', '', '', '', '',  // Col E-J (4-9)
                    'â€»æ„›æ•´æ½”', '', '', '', '', '',  // Col K-P (10-15)
                    'â€»å®ˆç§©åº', '', '', '', '', '',  // Col Q-V (16-21)
                    'â€»æœ‰ç¦®è²Œ', '', '', '', '', '',  // Col W-AB (22-27)
                    'â€»åšç’°ä¿', '', '', '', '', '',  // Col AC-AH (28-33)
                    'åœ˜é«”æ´»å‹•ç´€éŒ„',  // Col AI (34)
                    'å…¬å…±æœå‹™ç´€éŒ„', '',  // Col AJ-AK (35-36)
                    'æ ¡å…§å¤–ç‰¹æ®Šè¡¨ç¾ç´€éŒ„', '',  // Col AL-AM (37-38)
                    'å­¸æœŸæˆç¸¾å–®å°å¸«è©•èª',  // Col AN (39)
                    'å­¸ç±å¡å°å¸«è©•èª'  // Col AO (40)
                ];
                ws_data.push(row0);
                
                // Row 1: å­é …ç›®è¡¨é ­
                const row1 = [
                    '', '', '', '',  // Col A-D ç•™ç©ºï¼ˆå‚ç›´åˆä½µï¼‰
                ];
                
                // æ•¬æ„›äººå­é …ç›® (Col E-J, ç´¢å¼•4-9)
                BEHAVIOR_CONFIG['æ•¬æ„›äºº'].items.forEach(item => row1.push(item));
                row1.push('å…·é«”å»ºè­°');
                
                // æ„›æ•´æ½”å­é …ç›® (Col K-P, ç´¢å¼•10-15)
                BEHAVIOR_CONFIG['æ„›æ•´æ½”'].items.forEach(item => row1.push(item));
                row1.push('å…·é«”å»ºè­°');
                
                // å®ˆç§©åºå­é …ç›® (Col Q-V, ç´¢å¼•16-21)
                BEHAVIOR_CONFIG['å®ˆç§©åº'].items.forEach(item => row1.push(item));
                row1.push('å…·é«”å»ºè­°');
                
                // æœ‰ç¦®è²Œå­é …ç›® (Col W-AB, ç´¢å¼•22-27)
                BEHAVIOR_CONFIG['æœ‰ç¦®è²Œ'].items.forEach(item => row1.push(item));
                row1.push('å…·é«”å»ºè­°');
                
                // åšç’°ä¿å­é …ç›® (Col AC-AH, ç´¢å¼•28-33)
                BEHAVIOR_CONFIG['åšç’°ä¿'].items.forEach(item => row1.push(item));
                row1.push('å…·é«”å»ºè­°');
                
                // å¤šå…ƒç´€éŒ„å­é …ç›®
                row1.push('');  // Col AI (34) åœ˜é«”æ´»å‹•ç´€éŒ„ç•™ç©ºï¼ˆå‚ç›´åˆä½µï¼‰
                row1.push('æ ¡å…§æœå‹™');  // Col AJ (35)
                row1.push('ç¤¾å€æœå‹™');  // Col AK (36)
                row1.push('æ ¡å…§ç‰¹æ®Šè¡¨ç¾');  // Col AL (37)
                row1.push('æ ¡å¤–ç‰¹æ®Šè¡¨ç¾');  // Col AM (38)
                row1.push('');  // Col AN (39) å­¸æœŸæˆç¸¾å–®å°å¸«è©•èªç•™ç©ºï¼ˆå‚ç›´åˆä½µï¼‰
                row1.push('');  // Col AO (40) å­¸ç±å¡å°å¸«è©•èªç•™ç©ºï¼ˆå‚ç›´åˆä½µï¼‰
                
                ws_data.push(row1);
                
                // Row 2+: å­¸ç”Ÿè³‡æ–™
                processedStudents.forEach(s => {
                    const studentRow = [
                        grade,  // Col A: å¹´ç´š
                        classNum,  // Col B: ç­ç´šç·¨è™Ÿ
                        parseInt(s.id, 10) || 0,  // Col C: åº§è™Ÿ
                        s.name || ''  // Col D: å§“å
                    ];
                    
                    // 5 å¤§é¡è¡Œç‚ºæŒ‡æ¨™ï¼ˆæ¯é¡ 5 å€‹å­é¡Œ + 1 å€‹å…·é«”å»ºè­°ï¼‰
                    const categories = ['æ•¬æ„›äºº', 'æ„›æ•´æ½”', 'å®ˆç§©åº', 'æœ‰ç¦®è²Œ', 'åšç’°ä¿'];
                    categories.forEach(category => {
                        BEHAVIOR_CONFIG[category].items.forEach((_, idx) => {
                            studentRow.push((s.behavior[category] && s.behavior[category].items[idx]) || '');
                        });
                        studentRow.push((s.behavior[category] && s.behavior[category].suggestion) || '');
                    });
                    
                    // å¤šå…ƒç´€éŒ„
                    studentRow.push(s.records.groupActivity || '');  // Col AI: åœ˜é«”æ´»å‹•ç´€éŒ„
                    studentRow.push(s.records.publicServiceSchool || '');  // Col AJ: æ ¡å…§æœå‹™
                    studentRow.push(s.records.publicServiceCommunity || '');  // Col AK: ç¤¾å€æœå‹™
                    studentRow.push(s.records.specialPerformanceSchool || '');  // Col AL: æ ¡å…§ç‰¹æ®Šè¡¨ç¾
                    studentRow.push(s.records.specialPerformanceExternal || '');  // Col AM: æ ¡å¤–ç‰¹æ®Šè¡¨ç¾
                    
                    // è©•èª
                    studentRow.push(s.polished_comment || '');  // Col AN: å­¸æœŸæˆç¸¾å–®å°å¸«è©•èª
                    studentRow.push(s.motto || '');  // Col AO: å­¸ç±å¡å°å¸«è©•èª
                    
                    ws_data.push(studentRow);
                });
                
                // V6.0: ä½¿ç”¨ aoa_to_sheet å»ºç«‹å·¥ä½œè¡¨
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                
                // V6.0: è¨­å®šåˆä½µå„²å­˜æ ¼
                ws['!merges'] = [
                    // å‚ç›´åˆä½µ Row 0-1: åŸºæœ¬è³‡æ–™ (Col A-D)
                    { s: { r: 0, c: 0 }, e: { r: 1, c: 0 } },  // å¹´ç´š
                    { s: { r: 0, c: 1 }, e: { r: 1, c: 1 } },  // ç­ç´šç·¨è™Ÿ
                    { s: { r: 0, c: 2 }, e: { r: 1, c: 2 } },  // åº§è™Ÿ
                    { s: { r: 0, c: 3 }, e: { r: 1, c: 3 } },  // å§“å
                    
                    // æ°´å¹³åˆä½µ Row 0: æ•¬æ„›äºº (Col E-J, ç´¢å¼•4-9)
                    { s: { r: 0, c: 4 }, e: { r: 0, c: 9 } },
                    // æ°´å¹³åˆä½µ Row 0: æ„›æ•´æ½” (Col K-P, ç´¢å¼•10-15)
                    { s: { r: 0, c: 10 }, e: { r: 0, c: 15 } },
                    // æ°´å¹³åˆä½µ Row 0: å®ˆç§©åº (Col Q-V, ç´¢å¼•16-21)
                    { s: { r: 0, c: 16 }, e: { r: 0, c: 21 } },
                    // æ°´å¹³åˆä½µ Row 0: æœ‰ç¦®è²Œ (Col W-AB, ç´¢å¼•22-27)
                    { s: { r: 0, c: 22 }, e: { r: 0, c: 27 } },
                    // æ°´å¹³åˆä½µ Row 0: åšç’°ä¿ (Col AC-AH, ç´¢å¼•28-33)
                    { s: { r: 0, c: 28 }, e: { r: 0, c: 33 } },
                    
                    // å‚ç›´åˆä½µ Row 0-1: åœ˜é«”æ´»å‹•ç´€éŒ„ (Col AI, ç´¢å¼•34)
                    { s: { r: 0, c: 34 }, e: { r: 1, c: 34 } },
                    
                    // æ°´å¹³åˆä½µ Row 0: å…¬å…±æœå‹™ç´€éŒ„ (Col AJ-AK, ç´¢å¼•35-36)
                    { s: { r: 0, c: 35 }, e: { r: 0, c: 36 } },
                    // æ°´å¹³åˆä½µ Row 0: æ ¡å…§å¤–ç‰¹æ®Šè¡¨ç¾ç´€éŒ„ (Col AL-AM, ç´¢å¼•37-38)
                    { s: { r: 0, c: 37 }, e: { r: 0, c: 38 } },
                    
                    // å‚ç›´åˆä½µ Row 0-1: å­¸æœŸæˆç¸¾å–®å°å¸«è©•èª (Col AN, ç´¢å¼•39)
                    { s: { r: 0, c: 39 }, e: { r: 1, c: 39 } },
                    // å‚ç›´åˆä½µ Row 0-1: å­¸ç±å¡å°å¸«è©•èª (Col AO, ç´¢å¼•40)
                    { s: { r: 0, c: 40 }, e: { r: 1, c: 40 } }
                ];
                
                // V6.0: è¨­å®šå‡çµçª—æ ¼ - é–å®šå‰ 2 åˆ— (è¡¨é ­) èˆ‡å‰ 4 æ¬„ (åŸºæœ¬è³‡æ–™)
                ws['!views'] = [
                    {
                        state: 'frozen',
                        xSplit: 4,        // å‡çµ A, B, C, D æ¬„ (å¹´ç´šã€ç­ç´šç·¨è™Ÿã€åº§è™Ÿã€å§“å)
                        ySplit: 2,        // å‡çµç¬¬ 1, 2 åˆ— (é›™å±¤è¡¨é ­)
                        topLeftCell: 'E3', // è¨­å®šæ²å‹•èµ·å§‹é» (å¾ç¬¬ 3 åˆ—ã€E æ¬„é–‹å§‹)
                        activeCell: 'E3'   // è¨­å®šæ´»å‹•å„²å­˜æ ¼
                    }
                ];
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "æ—¥å¸¸è¡¨ç¾èˆ‡å°å¸«è©•èª");
                XLSX.writeFile(wb, `æ—¥å¸¸è¡Œç‚ºè¡¨ç¾èˆ‡å°å¸«è©•èªåŒ¯å…¥æª”(${grade}0${classNum}).xlsx`);
            };
            const copyResult = () => navigator.clipboard.writeText(currentStudent.value.polished_comment);

            return { 
                apiKey, isConfigLoaded, students, currentIdx, currentStudent, isGenerating, searchQuery, filteredStudents, selectedSubject, currentTags, 
                db, showClassManager, newClassName, newClassCount, currentClassData, showCloudModal, gasUrl, isSyncing, syncStatus,
                newGrade, newClassNum, isSidebarOpen, activeTab, // V6.0 Added activeTab
                BEHAVIOR_CONFIG, BEHAVIOR_OPTIONS, // V6.0 Exposed constants
                createNewClass, switchClass, deleteClass, handleImportExcel, resetCurrentClass, selectStudent, addTag, generateComment, exportToExcel, copyResult, uploadToCloud, downloadFromCloud,
                setDefaultBehavior // V6.0 Added
            };
        }
    }).mount('#app');
</script>
</body>
</html>