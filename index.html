<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å–µå—šè©•èªåŠ©æ‰‹ V7.1</title>
    <script src="config.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Varela Round', 'Noto Sans TC', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-[#FFF8F0] h-[100dvh] overflow-hidden text-[#5D4037]">

<div id="app" class="flex h-full w-full relative">

    <!-- æ–°æ‰‹å¼•å°ç²¾éˆ (Onboarding Wizard) -->
    <transition name="fade">
        <div v-if="showWelcomeWizard" class="fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-[#FFF8F0] rounded-3xl shadow-2xl max-w-md w-full border-4 border-[#FFE0B2] overflow-hidden flex flex-col">
                <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
                <div class="flex justify-center gap-2 pt-6 pb-2">
                    <div v-for="step in 3" :key="step" 
                         class="w-3 h-3 rounded-full transition-all duration-300"
                         :class="wizardStep >= step ? 'bg-[#FFB74D] scale-110' : 'bg-[#FFE0B2]'"></div>
                </div>

                <!-- æ­¥é©Ÿ 1ï¼šæ­¡è¿ -->
                <div v-show="wizardStep === 1" class="p-6 md:p-8 text-center">
                    <div class="text-6xl md:text-7xl mb-4">ğŸ±</div>
                    <h2 class="text-2xl md:text-3xl font-bold text-[#5D4037] mb-4">å—¨ï¼è€å¸«è¾›è‹¦äº†ï½</h2>
                    <p class="text-[#8D6E63] leading-relaxed mb-6">
                        æˆ‘æ˜¯ä½ çš„è©•èªå°å¹«æ‰‹ã€‚æœŸæœ«åˆ°äº†ï¼Œè®“æˆ‘ä¾†å¹«ä½ åˆ†æ“”ç¹é‡çš„è©•èªå·¥ä½œå§ï¼<br><br>
                        åœ¨é–‹å§‹ä¹‹å‰ï¼Œæˆ‘éœ€è¦ä¸€é»é»ã€Œèƒ½é‡ã€æ‰èƒ½é‹ä½œå–”ã€‚
                    </p>
                    <button @click="nextWizardStep" 
                            class="w-full py-3 bg-[#FFB74D] hover:bg-[#FFA726] text-white font-bold rounded-2xl shadow-md hover:shadow-lg transition-all transform hover:scale-[1.02]">
                        é–‹å§‹è¨­å®š â†’
                    </button>
                </div>

                <!-- æ­¥é©Ÿ 2ï¼šç²å– Key -->
                <div v-show="wizardStep === 2" class="p-6 md:p-8 text-center">
                    <div class="text-5xl md:text-6xl mb-4">ğŸ¥«</div>
                    <h2 class="text-xl md:text-2xl font-bold text-[#5D4037] mb-4">é ˜å–è²“ç½é ­ (API Key)</h2>
                    <div class="text-[#8D6E63] leading-relaxed mb-4 text-sm md:text-base text-left bg-[#FFF3E0] rounded-2xl p-4">
                        <ol class="list-decimal list-inside space-y-2">
                            <li>é»æ“Šä¸‹æ–¹é€£çµå‰å¾€ <strong class="text-[#5D4037]">Google AI Studio</strong></li>
                            <li>é»æ“Šé é¢ä¸Šçš„ <strong class="text-[#5D4037]">"Create API key"</strong> æŒ‰éˆ•</li>
                            <li class="text-[#E65100] font-medium">âš ï¸ é‡è¦ï¼šé¸æ“‡ <strong>"Create API key in new project"</strong></li>
                            <li>è¤‡è£½ç”Ÿæˆçš„å¯†ç¢¼ (ä»¥ <strong class="font-mono">AIza</strong> é–‹é ­)</li>
                        </ol>
                    </div>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" 
                       class="inline-flex items-center gap-2 px-6 py-3 bg-[#42A5F5] hover:bg-[#1E88E5] text-white font-bold rounded-2xl shadow-md hover:shadow-lg transition-all mb-4">
                        ğŸ”— å‰å¾€ Google AI Studio é ˜å–é‘°åŒ™
                    </a>
                    <p class="text-xs text-[#C5A89E] mb-4">
                        ğŸ–±ï¸ è¨˜å¾—é»é¸ <strong>"Create API key in new project"</strong> å–”ï¼
                    </p>
                    <div class="flex gap-3">
                        <button @click="prevWizardStep" 
                                class="flex-1 py-3 bg-[#FFE0B2] hover:bg-[#FFCC80] text-[#8D6E63] font-bold rounded-2xl transition-all">
                            â† ä¸Šä¸€æ­¥
                        </button>
                        <button @click="nextWizardStep" 
                                class="flex-1 py-3 bg-[#FFB74D] hover:bg-[#FFA726] text-white font-bold rounded-2xl shadow-md hover:shadow-lg transition-all">
                            æˆ‘è¤‡è£½å¥½äº† â†’
                        </button>
                    </div>
                </div>

                <!-- æ­¥é©Ÿ 3ï¼šè¼¸å…¥ Key -->
                <div v-show="wizardStep === 3" class="p-6 md:p-8 text-center">
                    <div class="text-5xl md:text-6xl mb-4">âœ¨</div>
                    <h2 class="text-xl md:text-2xl font-bold text-[#5D4037] mb-4">é¤µé£Ÿç½ç½ (è¼¸å…¥ Key)</h2>
                    <p class="text-[#8D6E63] leading-relaxed mb-4 text-sm">
                        å°‡å‰›å‰›è¤‡è£½çš„é‚£ä¸²å¯†ç¢¼è²¼åœ¨ä¸‹é¢ï¼š
                    </p>
                    <input type="text" v-model="wizardApiKey" 
                           placeholder="AIza... é–‹é ­çš„å¯†ç¢¼"
                           class="w-full px-4 py-3 text-center text-[#5D4037] rounded-2xl bg-white border-2 border-[#FFE0B2] focus:border-[#FFB74D] focus:ring-4 focus:ring-[#FFE0B2]/50 shadow-sm text-sm md:text-base mb-3 font-mono">
                    <!-- å…¬ç”¨é›»è…¦æ¨¡å¼ Checkbox -->
                    <label class="flex items-center justify-center gap-2 text-sm text-[#8D6E63] mb-4 cursor-pointer select-none">
                        <input type="checkbox" v-model="isPublicMode" class="w-4 h-4 accent-[#FFB74D] rounded">
                        <span>ğŸ’» æ­¤ç‚ºå…¬ç”¨é›»è…¦ (ä¸å„²å­˜é‡‘é‘°)</span>
                    </label>
                    <div class="flex gap-3 mb-4">
                        <button @click="prevWizardStep" 
                                class="flex-1 py-3 bg-[#FFE0B2] hover:bg-[#FFCC80] text-[#8D6E63] font-bold rounded-2xl transition-all">
                            â† ä¸Šä¸€æ­¥
                        </button>
                        <button @click="completeWizard" 
                                :disabled="!wizardApiKey.trim()"
                                class="flex-1 py-3 bg-[#FFB74D] hover:bg-[#FFA726] text-white font-bold rounded-2xl shadow-md hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                            âœ¨ å•Ÿå‹•åŠ©æ‰‹
                        </button>
                    </div>
                </div>

                <!-- è·³éæŒ‰éˆ• -->
                <div class="pb-4 text-center">
                    <button @click="skipWizard" class="text-xs text-[#C5A89E] hover:text-[#8D6E63] hover:underline transition">
                        è·³éæ•™å­¸ (é€²å…¥è©¦ç”¨)
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="isSidebarOpen" @click="isSidebarOpen = false" class="fixed inset-0 bg-black/50 z-20 md:hidden"></div>
    </transition>

    <transition name="fade">
        <div v-if="showCloudModal" class="absolute inset-0 z-50 bg-[#5D4037]/50 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full border-4 border-blue-200 overflow-hidden flex flex-col max-h-[90vh] overflow-y-auto">
                <div class="bg-blue-100 p-4 md:p-6 flex justify-between items-center">
                    <h2 class="text-xl md:text-2xl font-bold text-blue-800 flex items-center gap-2"><span>â˜ï¸</span> è²“è²“é›²ç«¯åŒæ­¥</h2>
                    <button @click="showCloudModal = false" class="text-[#8D6E63] hover:text-[#5D4037] text-2xl">âœ•</button>
                </div>
                <div class="p-6 flex flex-col gap-6">
                    <!-- GAS æ•™å­¸æ‘ºç–Šå€å¡Š -->
                    <details class="group">
                        <summary class="cursor-pointer font-bold text-[#FFB74D] hover:text-[#F57C00] list-none flex items-center gap-2 p-2">
                            <span class="transition-transform group-open:rotate-90">â–¶</span>
                            é‚„æ²’æœ‰é›²ç«¯è²“çª©ï¼Ÿæ•™æˆ‘æ€éº¼è“‹ä¸€å€‹ï¼ğŸ› ï¸
                        </summary>
                        <div class="bg-[#FFF3E0] rounded-2xl p-4 mt-2 text-sm text-[#5D4037] space-y-4">
                            <!-- Step 1 -->
                            <div>
                                <p class="font-bold mb-2">ğŸ“‹ Step 1ï¼šè¤‡è£½ç¨‹å¼ç¢¼</p>
                                <p class="mb-2">è«‹å…ˆè¤‡è£½ä»¥ä¸‹é€™æ®µç¨‹å¼ç¢¼ï¼š</p>
                                <div class="relative">
                                    <pre class="bg-white border-2 border-[#FFE0B2] rounded-xl p-3 text-xs overflow-x-auto font-mono text-[#5D4037] whitespace-pre-wrap">// âš ï¸ è«‹å°‡ä¸‹æ–¹ "meow1234" æ”¹ç‚ºè‡ªè¨‚å¯†èªï¼
var SECRET = "meow1234";

function doPost(e) {
  var payload = JSON.parse(e.postData.contents);
  // é©—è­‰é€šé—œå¯†èª
  if (payload.secret !== SECRET) {
    return ContentService.createTextOutput(JSON.stringify({"result":"error","message":"å¯†èªéŒ¯èª¤"})).setMimeType(ContentService.MimeType.JSON);
  }
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  sheet.getRange("A1").setValue(JSON.stringify(payload.data));
  return ContentService.createTextOutput(JSON.stringify({"result":"success"})).setMimeType(ContentService.MimeType.JSON);
}
function doGet(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = sheet.getRange("A1").getValue();
  return ContentService.createTextOutput(data).setMimeType(ContentService.MimeType.JSON);
}</pre>
                                    <button @click="copyGasCode" class="absolute top-2 right-2 px-3 py-1 bg-[#FFB74D] hover:bg-[#FFA726] text-white text-xs font-bold rounded-lg transition">ğŸ“‹ è¤‡è£½ä»£ç¢¼</button>
                                </div>
                            </div>
                            <!-- Step 2 -->
                            <div>
                                <p class="font-bold mb-2">ğŸ†• Step 2ï¼šå»ºç«‹å°ˆæ¡ˆ</p>
                                <p>é»æ“Š <a href="https://script.google.com/home/start" target="_blank" class="text-blue-500 hover:text-blue-700 underline font-bold">é€™è£¡å‰å¾€ Google Apps Script</a>ï¼Œé»é¸<strong>ã€æ–°å°ˆæ¡ˆã€</strong>ï¼Œä¸¦å°‡å‰›å‰›è¤‡è£½çš„ä»£ç¢¼ <strong>è¦†è“‹</strong> æ‰åŸæœ¬çš„å…§å®¹ã€‚</p>
                            </div>
                            <!-- Step 3 -->
                            <div>
                                <p class="font-bold mb-2">ğŸš€ Step 3ï¼šéƒ¨ç½²ç‚ºç¶²é æ‡‰ç”¨ç¨‹å¼</p>
                                <p class="mb-1">é»æ“Šå³ä¸Šè§’ <strong>ã€éƒ¨ç½²ã€(Deploy)</strong> â†’ <strong>ã€æ–°å¢éƒ¨ç½²ã€</strong>ï¼š</p>
                                <ol class="list-decimal list-inside space-y-1 pl-2">
                                    <li>é¡å‹é¸æ“‡ï¼š<strong>ç¶²é æ‡‰ç”¨ç¨‹å¼ (Web App)</strong></li>
                                    <li>èª°å¯ä»¥å­˜å–ï¼šå‹™å¿…é¸ <strong class="text-red-500">ã€æ‰€æœ‰äºº (Anyone)ã€</strong> (å¾ˆé‡è¦ï¼)</li>
                                    <li>é»æ“Š <strong>ã€éƒ¨ç½²ã€</strong></li>
                                </ol>
                            </div>
                            <!-- Step 4 -->
                            <div>
                                <p class="font-bold mb-2">ğŸ”— Step 4ï¼šå–å¾—ç¶²å€</p>
                                <p>è¤‡è£½éƒ¨ç½²å®Œæˆå¾Œçš„ <strong>ã€ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ã€</strong>ï¼ˆä»¥ <code class="bg-white px-1 rounded">exec</code> çµå°¾ï¼‰ï¼Œä¸¦è²¼åˆ°ä¸‹æ–¹çš„è¼¸å…¥æ¡†ä¸­ã€‚</p>
                            </div>
                        </div>
                    </details>

                    <div class="space-y-2">
                        <label class="text-sm font-bold text-[#8D6E63] uppercase">æ‚¨çš„ Google Script ç¶²å€ (GAS URL)</label>
                        <input type="text" v-model="gasUrl" placeholder="è«‹è²¼ä¸Š https://script.google.com/.../exec" class="w-full p-3 border-2 rounded-2xl text-sm bg-white focus:ring-4 focus:ring-[#FFE0B2]/50 outline-none transition-all border-[#FFE0B2] focus:border-[#FFB74D]" :class="gasUrl ? '' : 'border-red-300'">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-bold text-[#8D6E63] uppercase flex items-center gap-2">ğŸ” é€šé—œå¯†èª (Secret Token)</label>
                        <input type="password" v-model="gasSecret" placeholder="é è¨­: meow1234 (å»ºè­°è‡ªè¨‚)" class="w-full p-3 border-2 rounded-2xl text-sm bg-white focus:ring-4 focus:ring-[#FFE0B2]/50 outline-none transition-all border-[#FFE0B2] focus:border-[#FFB74D]">
                        <p class="text-xs text-[#C5A89E]">âš ï¸ æ­¤å¯†èªé ˆèˆ‡ GAS å¾Œç«¯ç¨‹å¼ç¢¼ä¸­çš„å¯†èªä¸€è‡´ï¼Œæ‰èƒ½æˆåŠŸåŒæ­¥ã€‚</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button @click="uploadToCloud" :disabled="!gasUrl || isSyncing" class="flex flex-col items-center justify-center p-4 rounded-3xl border-2 border-[#FFE0B2] hover:bg-[#FFF3E0] transition gap-2 disabled:opacity-50"><span class="text-3xl">â¬†ï¸</span><span class="font-bold text-[#5D4037]">ä¸Šå‚³å‚™ä»½</span></button>
                        <button @click="downloadFromCloud" :disabled="!gasUrl || isSyncing" class="flex flex-col items-center justify-center p-4 rounded-3xl border-2 border-[#FFE0B2] hover:bg-[#FFF3E0] transition gap-2 disabled:opacity-50"><span class="text-3xl">â¬‡ï¸</span><span class="font-bold text-[#5D4037]">ä¸‹è¼‰é‚„åŸ</span></button>
                    </div>
                    <div v-if="syncStatus" class="text-center text-sm font-bold p-3 rounded-3xl transition-all" :class="syncStatus.includes('æˆåŠŸ') ? 'bg-green-100 text-green-700' : (syncStatus.includes('å¤±æ•—') ? 'bg-red-100 text-red-700' : 'bg-[#FFF3E0] text-[#8D6E63]')">{{ syncStatus }}</div>
                    
                    <!-- V7.1 è³‡å®‰ï¼šä¸€éµæ¸…é™¤æ•æ„Ÿè³‡æ–™ -->
                    <div class="border-t border-[#FFE0B2] pt-4 mt-2">
                        <button @click="clearAllData" class="w-full py-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-2xl shadow-md transition-all flex items-center justify-center gap-2">
                            <span>ğŸ—‘ï¸</span> æ¸…é™¤æ‰€æœ‰æ•æ„Ÿè³‡æ–™ (Panic Button)
                        </button>
                        <p class="text-xs text-[#C5A89E] text-center mt-2">âš ï¸ æ­¤æ“ä½œå°‡æ¸…é™¤ API Keyã€GAS ç¶²å€ã€é€šé—œå¯†èªï¼Œä¸¦é‡æ–°æ•´ç†é é¢ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="showClassManager" class="absolute inset-0 z-50 bg-[#5D4037]/40 backdrop-blur-sm flex items-center justify-center p-2 md:p-4">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl border-4 border-[#FFE0B2] overflow-hidden flex flex-col max-h-[90vh]">
                <div class="bg-[#FFE0B2] p-4 md:p-6 flex justify-between items-center">
                    <h2 class="text-xl md:text-2xl font-bold text-[#5D4037] flex items-center gap-2"><span>ğŸ¡</span> è²“çª©ç®¡ç†</h2>
                    <button @click="showClassManager = false" class="text-[#8D6E63] hover:text-[#5D4037] text-2xl">âœ•</button>
                </div>
                <div class="p-4 md:p-6 overflow-y-auto flex-1">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                        <div v-for="(cls, id) in db.classes" :key="id" @click="switchClass(id)"
                             class="p-4 rounded-3xl border-2 cursor-pointer transition-all relative group"
                             :class="db.activeClassId === id ? 'border-[#FFB74D] bg-[#FFF8F0] ring-2 ring-[#FFE0B2]' : 'border-[#FFE0B2] hover:border-[#FFCC80]'">
                            <div class="font-bold text-lg text-[#5D4037]">
                                {{ cls.grade }} å¹´ {{ cls.classNum }} ç­
                                <span class="text-sm font-normal text-[#8D6E63] block md:inline">({{ cls.name || 'æœªå‘½å' }})</span>
                            </div>
                            <div class="text-xs text-[#8D6E63] mt-1">{{ cls.students.length }} éš»å°è²“</div>
                            <div v-if="db.activeClassId === id" class="absolute top-2 right-2 text-[#FFB74D] text-xs font-bold bg-white px-2 py-0.5 rounded-full border border-[#FFCC80]">ç•¶å‰</div>
                            <div class="absolute bottom-2 right-2 flex gap-1">
                                <button @click.stop="editClass(id)" class="text-[#C5A89E] hover:text-[#5D4037] md:opacity-0 group-hover:opacity-100 transition-opacity p-1" title="ç·¨è¼¯ç­ç´š">âœï¸</button>
                                <button v-if="Object.keys(db.classes).length > 1" @click.stop="deleteClass(id)" class="text-[#C5A89E] hover:text-red-500 md:opacity-0 group-hover:opacity-100 transition-opacity p-1" title="åˆªé™¤ç­ç´š">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                    <div class="border-t border-[#FFE0B2] my-4"></div>
                    
                    <div class="bg-[#FFF8F0] p-4 rounded-3xl border-2 border-[#FFE0B2]">
                        <h3 class="font-bold text-[#5D4037] mb-3">{{ editingClassId ? 'âœï¸ ç·¨è¼¯ç­ç´š' : 'ğŸ†• å»ºç«‹æ–°ç­ç´š' }}</h3>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div><label class="text-xs text-[#8D6E63] block mb-1">å¹´ç´š (æ•¸å­—)</label><input v-model="newGrade" type="number" min="1" max="6" placeholder="å¦‚: 4" class="w-full px-3 py-2 border-2 rounded-2xl text-sm text-center font-bold bg-white border-[#FFE0B2] focus:border-[#FFB74D] focus:ring-4 focus:ring-[#FFE0B2]/50"></div>
                            <div><label class="text-xs text-[#8D6E63] block mb-1">ç­åº (æ•¸å­—)</label><input v-model="newClassNum" type="number" min="1" max="30" placeholder="å¦‚: 7" class="w-full px-3 py-2 border-2 rounded-2xl text-sm text-center font-bold bg-white border-[#FFE0B2] focus:border-[#FFB74D] focus:ring-4 focus:ring-[#FFE0B2]/50"></div>
                        </div>
                        <div class="flex gap-2 items-center"><span class="text-xs text-[#8D6E63] whitespace-nowrap">åˆ¥å:</span><input v-model="newClassName" type="text" placeholder="é¸å¡«" class="flex-1 px-3 py-2 border-2 rounded-2xl text-sm bg-white border-[#FFE0B2] focus:border-[#FFB74D] focus:ring-4 focus:ring-[#FFE0B2]/50"></div>
                        <div class="flex gap-2 items-center mt-3">
                            <span v-if="!editingClassId || (editingClassId && db.classes[editingClassId] && db.classes[editingClassId].students.length === 0)" class="text-xs text-[#8D6E63] whitespace-nowrap">äººæ•¸:</span>
                            <input v-if="!editingClassId || (editingClassId && db.classes[editingClassId] && db.classes[editingClassId].students.length === 0)" v-model.number="newClassCount" type="number" min="1" max="50" class="w-16 px-2 py-1 border-2 rounded-2xl text-sm text-center bg-white border-[#FFE0B2] focus:border-[#FFB74D] focus:ring-4 focus:ring-[#FFE0B2]/50">
                            <button @click="editingClassId ? updateClass() : createNewClass()" 
                                    :class="editingClassId ? 'flex-1 bg-[#FFB74D] hover:bg-[#FFA726]' : 'flex-1 bg-[#FFB74D] hover:bg-[#FFA726]'"
                                    class="text-white text-sm font-bold py-2 rounded-2xl transition">
                                {{ editingClassId ? 'ğŸ’¾ å„²å­˜ä¿®æ”¹' : 'å»ºç«‹' }}
                            </button>
                            <button v-if="editingClassId" @click="cancelEdit" class="px-3 py-2 bg-[#C5A89E] hover:bg-[#8D6E63] text-white text-sm font-bold rounded-2xl transition">å–æ¶ˆ</button>
                        </div>
                    </div>
                    
                    <div class="mt-4 bg-[#FFF3E0] p-4 rounded-3xl border-2 border-[#FFE0B2] relative overflow-hidden group">
                        <h3 class="font-bold text-[#5D4037] mb-2">ğŸ“‚ åŒ¯å…¥èˆŠ Excel</h3>
                        <label class="block w-full bg-white border-2 border-[#FFE0B2] text-[#5D4037] hover:bg-[#FFB74D] hover:text-white text-center py-2 rounded-2xl cursor-pointer transition text-sm font-bold shadow-sm">é¸æ“‡æª”æ¡ˆåŒ¯å…¥<input type="file" accept=".xlsx, .xls" class="hidden" @change="handleImportExcel"></label>
                    </div>
                </div>
            </div>
        </div>
    </transition>
    
    <div class="fixed md:relative z-30 h-full w-[85vw] md:w-80 bg-white/90 backdrop-blur md:backdrop-blur-0 border-4 border-[#FFE0B2] ml-0 md:m-4 rounded-r-3xl md:rounded-3xl shadow-xl flex flex-col transition-transform duration-300 ease-in-out transform"
         :class="isSidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'">
        
        <div class="p-4 bg-[#FFE0B2] text-[#5D4037] shadow-md z-20 relative overflow-hidden shrink-0 rounded-tr-3xl md:rounded-t-3xl">
            <div class="relative z-10">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2 cursor-pointer hover:bg-[#FFCC80]/60 rounded-2xl p-1 transition" @click="showClassManager = true">
                        <span class="text-xl">ğŸ¾</span>
                        <h1 class="text-lg font-bold tracking-wide">
                            <span v-if="currentClassData.grade">{{ currentClassData.grade }}å¹´{{ currentClassData.classNum }}ç­</span>
                            <span v-else>{{ currentClassData.name || 'é¸æ“‡ç­ç´š' }}</span>
                        </h1>
                        <span class="text-xs bg-white/70 px-2 py-0.5 rounded-2xl text-[#8D6E63]">â–¼</span>
                    </div>
                    <button @click="isSidebarOpen = false" class="md:hidden text-[#8D6E63] hover:text-[#5D4037] text-xl font-bold p-1">âœ•</button>
                </div>
                <div class="relative">
                    <input type="text" v-model="searchQuery" placeholder="æœå°‹å§“å/åº§è™Ÿ..." class="w-full pl-8 pr-3 py-2 text-[#5D4037] rounded-2xl bg-white border-2 border-[#FFE0B2] focus:border-[#FFB74D] focus:ring-4 focus:ring-[#FFE0B2]/50 shadow-sm text-sm placeholder-[#C5A89E]">
                    <span class="absolute left-2.5 top-2 text-[#C5A89E] text-xs">ğŸ”</span>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-3 pb-0 space-y-2 no-scrollbar bg-[#FFF8F0]">
            <div v-for="(student, index) in filteredStudents" :key="student.id" @click="selectStudent(student.originalIndex)" 
                 class="group relative p-3 rounded-3xl cursor-pointer border transition-all duration-200 pr-8" 
                 :class="currentIdx === student.originalIndex ? 'bg-white border-[#FFB74D] shadow-md ring-2 ring-[#FFE0B2]' : 'bg-white/80 border-transparent hover:bg-white hover:border-[#FFCC80]'">
                <div class="flex flex-col">
                    <span class="text-xs font-mono text-[#8D6E63] mb-0.5 flex items-center gap-1"><span class="text-[10px]">ğŸ¾</span> åº§è™Ÿ {{ student.id }}</span>
                    <div class="flex items-center gap-2">
                        <span v-if="student.name" class="font-bold text-[#5D4037] text-lg">{{ student.name }}</span>
                        <span v-else class="text-[#8D6E63] text-sm italic">(é»æ“Šè¼¸å…¥)</span>
                        <span v-if="student.polished_comment" class="text-[10px] text-white font-bold bg-[#FFB74D] px-2 py-0.5 rounded-full border border-[#FFCC80]">âœ”</span>
                    </div>
                </div>
            </div>
            <div class="h-3"></div>
        </div>
        <div class="p-3 md:p-4 border-t-2 border-[#FFCC80] text-sm text-[#8D6E63] bg-[#FFF3E0] flex justify-between items-center px-4 shrink-0 safe-area-bottom rounded-br-[20px] md:rounded-b-[20px] shadow-inner">
            <span class="font-medium">ğŸ¾ {{ students.length }} éš»å°è²“</span>
            <button @click="resetCurrentClass" class="text-red-400 hover:text-red-600 hover:underline font-medium">æ¸…ç©ºæœ¬ç­</button>
        </div>
    </div>

    <div class="flex-1 flex flex-col h-full bg-white/90 relative w-full overflow-hidden md:rounded-3xl md:m-4 shadow-xl md:border-4 border-[#FFE0B2]">
        <div class="bg-[#FFF8F0] border-b border-[#FFCC80] flex flex-col md:flex-row items-start md:items-center justify-between p-2 md:p-3 md:px-8 shadow-sm z-10 gap-2 md:gap-3 shrink-0">
            
            <div class="flex items-center w-full md:w-auto justify-between">
                <div class="flex items-center gap-2">
                    <button @click="isSidebarOpen = true" class="md:hidden p-2 -ml-2 text-[#8D6E63] hover:bg-[#FFF3E0] rounded-2xl">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold uppercase whitespace-nowrap" :class="apiKey ? 'text-emerald-600' : 'text-red-500'">{{ apiKey ? 'ğŸ”‘ OK' : 'ğŸ”‘ æœªè¼¸å…¥' }}</span>
                        <input type="password" v-model="apiKey" :disabled="isConfigLoaded" placeholder="API Key..." class="bg-white border-2 rounded-2xl px-2 py-1 w-20 md:w-24 text-sm focus:w-64 transition-all focus:outline-none disabled:bg-[#FFF3E0] border-[#FFE0B2] focus:border-[#FFB74D] focus:ring-4 focus:ring-[#FFE0B2]/50">
                        <label class="hidden md:flex items-center gap-1 text-xs text-[#8D6E63] cursor-pointer select-none" title="å‹¾é¸å¾Œé‡‘é‘°ä¸æœƒå„²å­˜ï¼Œé‡æ•´é é¢å¾Œéœ€é‡æ–°è¼¸å…¥">
                            <input type="checkbox" v-model="isPublicMode" class="w-3 h-3 accent-[#FFB74D] rounded">
                            <span>ğŸ’» å…¬ç”¨</span>
                        </label>
                        <button @click="openWizard" class="w-8 h-8 md:w-9 md:h-9 flex items-center justify-center bg-white text-[#FFB74D] border-2 border-[#FFE0B2] hover:bg-[#FFF3E0] hover:border-[#FFB74D] rounded-full shadow-sm transition font-bold text-sm" title="Gemini API Key å–å¾—æ•™å­¸èªªæ˜">â“</button>
                    </div>
                </div>
                
                <div v-if="currentStudent" class="md:hidden font-bold text-[#5D4037] truncate max-w-[100px]">{{ currentStudent.name }}</div>
            </div>

            <div class="flex items-center justify-between w-full md:w-auto gap-3 overflow-x-auto no-scrollbar">
                <div class="flex items-center gap-2 md:border-l md:pl-4 border-[#FFE0B2] shrink-0">
                    <span class="text-sm font-bold text-[#8D6E63] hidden md:inline">é ˜åŸŸï¼š</span>
                    <select v-model="selectedSubject" class="bg-white border-2 border-[#FFE0B2] text-[#5D4037] text-xs md:text-sm rounded-xl md:rounded-2xl focus:ring-4 focus:ring-[#FFE0B2]/50 focus:border-[#FFB74D] block p-1.5 md:p-2 font-bold cursor-pointer min-w-[120px] md:min-w-[180px]">
                        <option value="ä¸€èˆ¬å°å¸«">å°å¸« (ç­ç´šç¶“ç‡Ÿ)</option>
                        <option value="åœ‹èªæ–‡">åœ‹èªæ–‡</option>
                        <option value="æ•¸å­¸">æ•¸å­¸</option>
                        <option value="è‹±èªæ–‡">è‹±èªæ–‡</option>
                        <option value="è‡ªç„¶ç§‘å­¸">è‡ªç„¶ç§‘å­¸</option>
                        <option value="ç¤¾æœƒ">ç¤¾æœƒ</option>
                        <option value="è—è¡“">è—è¡“</option>
                        <option value="å¥åº·èˆ‡é«”è‚²">å¥é«”</option>
                        <option value="ç¶œåˆæ´»å‹•">ç¶œåˆ</option>
                    </select>
                </div>
                <div class="flex gap-1.5 md:gap-2 shrink-0">
                    <button @click="showCloudModal = true" class="flex items-center gap-1 bg-[#42A5F5] hover:bg-[#1E88E5] text-white px-3 py-1.5 md:px-4 md:py-2 rounded-xl md:rounded-2xl shadow-md hover:shadow-lg transition text-xs md:text-sm font-bold">â˜ï¸ <span class="hidden sm:inline">åŒæ­¥</span></button>
                    <button @click="exportToExcel" class="flex items-center gap-1 bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 md:px-4 md:py-2 rounded-xl md:rounded-2xl shadow-md hover:shadow-lg transition text-xs md:text-sm font-bold">ğŸ“¥ <span class="hidden sm:inline">åŒ¯å‡º</span></button>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 bg-[#FFF8F0]" v-if="currentStudent">
            <div class="max-w-6xl mx-auto pb-20 md:pb-0">
                <!-- å­¸ç”Ÿå§“åå€å¡Š -->
                <div class="bg-white p-4 rounded-3xl shadow-sm border-2 border-[#FFCC80] flex items-center gap-4 mb-4">
                    <div class="w-10 h-10 md:w-12 md:h-12 rounded-full bg-[#FFF3E0] flex items-center justify-center text-xl md:text-2xl select-none">ğŸ±</div>
                    <div class="flex-1">
                        <label class="text-xs font-bold text-[#8D6E63] uppercase">å­¸ç”Ÿå§“å</label>
                        <input type="text" v-model="currentStudent.name" placeholder="è¼¸å…¥åå­—..." class="w-full text-xl md:text-2xl font-bold text-[#5D4037] border-b border-transparent focus:border-[#FFB74D] focus:outline-none bg-transparent">
                    </div>
                </div>

                <!-- Tabs å°èˆª -->
                <div class="bg-white rounded-3xl shadow-sm border-2 border-[#FFCC80] mb-4 overflow-hidden">
                    <div class="flex gap-1.5 md:gap-2 p-2 overflow-x-auto no-scrollbar bg-[#FFF8F0]">
                        <button @click="activeTab = 'comment'" 
                                class="flex-1 px-3 md:px-4 py-2 text-xs md:text-base font-bold transition-all rounded-full whitespace-nowrap"
                                :class="activeTab === 'comment' ? 'bg-[#FFB74D] text-white shadow-md transform -translate-y-1' : 'bg-[#FFF3E0] text-[#8D6E63] hover:bg-[#FFE0B2]'">
                            ğŸ“ <span class="hidden xs:inline">è©•èª</span><span class="inline xs:hidden">è©•èª</span>
                        </button>
                        <button @click="activeTab = 'behavior'" 
                                class="flex-1 px-3 md:px-4 py-2 text-xs md:text-base font-bold transition-all rounded-full whitespace-nowrap"
                                :class="activeTab === 'behavior' ? 'bg-[#FFB74D] text-white shadow-md transform -translate-y-1' : 'bg-[#FFF3E0] text-[#8D6E63] hover:bg-[#FFE0B2]'">
                            ğŸ“Š <span class="hidden xs:inline">è¡Œç‚º</span><span class="inline xs:hidden">è¡Œç‚º</span>
                        </button>
                        <button @click="activeTab = 'records'" 
                                class="flex-1 px-3 md:px-4 py-2 text-xs md:text-base font-bold transition-all rounded-full whitespace-nowrap"
                                :class="activeTab === 'records' ? 'bg-[#FFB74D] text-white shadow-md transform -translate-y-1' : 'bg-[#FFF3E0] text-[#8D6E63] hover:bg-[#FFE0B2]'">
                            ğŸ† <span class="hidden xs:inline">ç´€éŒ„</span><span class="inline xs:hidden">ç´€éŒ„</span>
                        </button>
                    </div>

                    <!-- Tab 1: è©•èªç”Ÿæˆ -->
                    <div v-show="activeTab === 'comment'" class="p-4 md:p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                            <div class="flex flex-col gap-4">
                                <div class="bg-[#FFF8F0] p-4 rounded-3xl border-2 border-[#FFE0B2]">
                                    <div class="text-xs font-bold text-[#8D6E63] mb-2 uppercase tracking-wider flex items-center gap-1"><span>ğŸ¾</span> å¿«é€Ÿæ¨™ç±¤</div>
                                    <div class="flex flex-wrap gap-2 max-h-32 overflow-y-auto">
                                        <button v-for="tag in currentTags" :key="tag" @click="addTag(tag)" class="px-2 py-1 md:px-3 text-xs md:text-sm bg-white hover:bg-[#FFE0B2] hover:text-[#5D4037] text-[#8D6E63] rounded-full border-2 border-[#FFE0B2] transition-colors">{{ tag }}</button>
                                    </div>
                                </div>
                                <div class="flex-1 flex flex-col bg-white rounded-3xl shadow-sm border-2 border-[#FFE0B2] overflow-hidden min-h-[200px]">
                                    <div class="p-3 bg-[#FFF3E0] border-b border-[#FFCC80] flex justify-between items-center">
                                        <h3 class="font-bold text-[#5D4037] flex items-center gap-2 text-sm md:text-base"><span>ğŸ“</span> è§€å¯Ÿç´€éŒ„</h3>
                                        <button @click="currentStudent.raw_comment = ''" class="text-xs text-[#8D6E63] hover:text-red-500">æ¸…ç©º</button>
                                    </div>
                                    <textarea v-model="currentStudent.raw_comment" class="flex-1 w-full p-4 resize-none focus:outline-none text-[#5D4037] leading-relaxed placeholder-[#C5A89E] bg-transparent text-sm md:text-base" placeholder="è«‹è¼¸å…¥è§€å¯Ÿç´€éŒ„..."></textarea>
                                </div>
                            </div>
                            <div class="flex flex-col gap-4">
                                <div class="bg-white p-4 rounded-3xl shadow-sm border-2 border-[#FFCC80] relative overflow-hidden">
                                    <div class="absolute top-0 right-0 bg-[#C5A89E] text-white text-[10px] md:text-xs px-2 py-1 rounded-bl-2xl font-bold">å­¸ç±å¡è©•èª (åš´è¬¹)</div>
                                    <div class="text-center py-2 flex items-center justify-center min-h-[3rem]">
                                        <div v-if="currentStudent.motto" class="text-lg md:text-xl font-bold text-[#5D4037] tracking-widest font-serif">{{ currentStudent.motto }}</div>
                                        <div v-else class="text-[#C5A89E] text-xs md:text-sm flex items-center gap-2"><span>âš–ï¸</span> ç­‰å¾…ç”Ÿæˆ...</div>
                                    </div>
                                </div>
                                <div class="flex-1 flex flex-col bg-white rounded-3xl shadow-lg border-2 border-[#FFCC80] overflow-hidden relative ring-1 ring-[#FFE0B2] min-h-[250px]">
                                    <div class="p-3 bg-gradient-to-r from-[#FFF8F0] to-white border-b border-[#FFCC80] flex justify-between items-center">
                                        <h3 class="font-bold text-[#5D4037] flex items-center gap-2 text-sm md:text-base"><span>âœ¨</span> è€å¸«è©•èª (æš–å¿ƒ)</h3>
                                        <button v-if="currentStudent.polished_comment" @click="copyResult" class="text-xs text-[#8D6E63] font-bold hover:bg-[#FFF3E0] px-2 py-1 rounded-2xl transition">è¤‡è£½</button>
                                    </div>
                                    <textarea v-model="currentStudent.polished_comment" class="flex-1 w-full p-4 md:p-6 resize-none focus:outline-none text-[#5D4037] leading-relaxed bg-white text-sm md:text-base" placeholder="è²“è²“ç”Ÿæˆçš„æš–å¿ƒè©•èªå°‡é¡¯ç¤ºæ–¼æ­¤..."></textarea>
                                    <div class="absolute bottom-4 right-4 md:bottom-6 md:right-6 z-10">
                                    <button @click="generateComment" :disabled="isGenerating || !apiKey" 
                                            class="flex items-center justify-center gap-2 px-6 py-3 md:px-8 md:py-4 rounded-full shadow-xl transition-all transform active:scale-95 md:hover:scale-110 disabled:opacity-80 disabled:cursor-not-allowed disabled:transform-none text-white font-bold text-sm md:text-base" 
                                            :class="!apiKey ? 'bg-[#C5A89E]' : 'bg-[#FFB74D] hover:bg-[#FFA726]'">
                                            <span v-if="!apiKey">ğŸš« ç¼º Key</span>
                                            <span v-else-if="isGenerating">ğŸ¾ æ€è€ƒä¸­...</span>
                                            <span v-else>ğŸ¾ å¹«æˆ‘å¯«</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 2: è¡Œç‚ºé‡è¡¨ -->
                    <div v-show="activeTab === 'behavior'" class="p-3 md:p-6 overflow-y-auto max-h-[calc(100vh-260px)] md:max-h-[calc(100vh-300px)]">
                        <div class="mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                            <h3 class="text-base md:text-xl font-bold text-[#5D4037]">è¡Œç‚ºé‡è¡¨è©•ç­‰</h3>
                            <button @click="setDefaultBehavior" class="px-3 md:px-4 py-1.5 md:py-2 bg-emerald-500 hover:bg-emerald-600 text-white text-xs md:text-sm font-bold rounded-xl md:rounded-2xl shadow-md transition transform active:scale-95 whitespace-nowrap">
                                âš¡ ä¸€éµé è¨­ (å¤§éƒ¨åˆ†ç¬¦åˆ)
                            </button>
                        </div>
                        <div class="space-y-6" v-if="currentStudent.behavior">
                            <div v-for="(config, category) in BEHAVIOR_CONFIG" :key="category" class="bg-white rounded-2xl md:rounded-3xl shadow-sm border-2 border-[#FFCC80] p-3 md:p-6">
                                <h4 class="text-sm md:text-lg font-bold text-[#5D4037] mb-3 md:mb-4 pb-2 border-b border-[#FFE0B2]">ã€{{ category }}ã€‘</h4>
                                <div class="space-y-2.5 md:space-y-3 mb-4">
                                    <div v-for="(item, idx) in config.items" :key="idx" class="flex flex-col md:flex-row md:items-center gap-1.5 md:gap-2">
                                        <label class="text-[13px] md:text-[15px] font-medium text-[#5D4037] flex-1 md:min-w-[300px] leading-snug">{{ item }}</label>
                                        <select v-model="currentStudent.behavior[category].items[idx]" 
                                                class="px-2.5 md:px-3 py-1.5 md:py-2 border-2 border-[#FFE0B2] rounded-xl md:rounded-2xl text-xs md:text-sm bg-white focus:ring-4 focus:ring-[#FFE0B2]/50 focus:border-[#FFB74D] outline-none w-full md:w-auto">
                                            <option value="">è«‹é¸æ“‡</option>
                                            <option v-for="opt in BEHAVIOR_OPTIONS" :key="opt" :value="opt">{{ opt }}</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-3 md:mt-4 pt-3 md:pt-4 border-t border-[#FFE0B2]">
                                    <label class="text-xs md:text-sm font-bold text-[#8D6E63] block mb-1.5 md:mb-2">å…·é«”å»ºè­°ï¼š</label>
                                    <textarea v-model="currentStudent.behavior[category].suggestion" 
                                              placeholder="è«‹è¼¸å…¥å…·é«”å»ºè­°..." 
                                              class="w-full px-2.5 md:px-3 py-1.5 md:py-2 border-2 border-[#FFE0B2] rounded-xl md:rounded-2xl text-xs md:text-sm resize-none focus:ring-4 focus:ring-[#FFE0B2]/50 focus:border-[#FFB74D] outline-none"
                                              rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                        <div v-else class="text-center py-8 text-[#8D6E63]">
                            <p>æ­£åœ¨åˆå§‹åŒ–è¡Œç‚ºé‡è¡¨...</p>
                        </div>
                    </div>

                    <!-- Tab 3: å¤šå…ƒç´€éŒ„ -->
                    <div v-show="activeTab === 'records'" class="p-3 md:p-6 overflow-y-auto max-h-[calc(100vh-260px)] md:max-h-[calc(100vh-300px)]">
                        <h3 class="text-base md:text-xl font-bold text-[#5D4037] mb-3 md:mb-4">å¤šå…ƒè¡¨ç¾ç´€éŒ„</h3>
                        <div class="space-y-3 md:space-y-4" v-if="currentStudent.records">
                            <div class="bg-white rounded-2xl md:rounded-3xl shadow-sm border-2 border-[#FFCC80] p-3 md:p-6">
                                <label class="text-xs md:text-base font-bold text-[#5D4037] block mb-1.5 md:mb-2">åœ˜é«”æ´»å‹•ç´€éŒ„</label>
                                <textarea v-model="currentStudent.records.groupActivity" 
                                          placeholder="è«‹è¼¸å…¥åœ˜é«”æ´»å‹•ç´€éŒ„..." 
                                          class="w-full px-2.5 md:px-3 py-1.5 md:py-2 border-2 border-[#FFE0B2] rounded-xl md:rounded-2xl text-xs md:text-sm resize-none focus:ring-4 focus:ring-[#FFE0B2]/50 focus:border-[#FFB74D] outline-none"
                                          rows="2"></textarea>
                            </div>
                            <div class="bg-white rounded-2xl md:rounded-3xl shadow-sm border-2 border-[#FFCC80] p-3 md:p-6">
                                <label class="text-xs md:text-base font-bold text-[#5D4037] block mb-1.5 md:mb-2">å…¬å…±æœå‹™ç´€éŒ„ - æ ¡å…§æœå‹™</label>
                                <textarea v-model="currentStudent.records.publicServiceSchool" 
                                          placeholder="è«‹è¼¸å…¥æ ¡å…§æœå‹™ç´€éŒ„..." 
                                          class="w-full px-2.5 md:px-3 py-1.5 md:py-2 border-2 border-[#FFE0B2] rounded-xl md:rounded-2xl text-xs md:text-sm resize-none focus:ring-4 focus:ring-[#FFE0B2]/50 focus:border-[#FFB74D] outline-none"
                                          rows="2"></textarea>
                            </div>
                            <div class="bg-white rounded-2xl md:rounded-3xl shadow-sm border-2 border-[#FFCC80] p-3 md:p-6">
                                <label class="text-xs md:text-base font-bold text-[#5D4037] block mb-1.5 md:mb-2">å…¬å…±æœå‹™ç´€éŒ„ - ç¤¾å€æœå‹™</label>
                                <textarea v-model="currentStudent.records.publicServiceCommunity" 
                                          placeholder="è«‹è¼¸å…¥ç¤¾å€æœå‹™ç´€éŒ„..." 
                                          class="w-full px-2.5 md:px-3 py-1.5 md:py-2 border-2 border-[#FFE0B2] rounded-xl md:rounded-2xl text-xs md:text-sm resize-none focus:ring-4 focus:ring-[#FFE0B2]/50 focus:border-[#FFB74D] outline-none"
                                          rows="2"></textarea>
                            </div>
                            <div class="bg-white rounded-2xl md:rounded-3xl shadow-sm border-2 border-[#FFCC80] p-3 md:p-6">
                                <label class="text-xs md:text-base font-bold text-[#5D4037] block mb-1.5 md:mb-2">æ ¡å…§å¤–ç‰¹æ®Šè¡¨ç¾ - æ ¡å…§</label>
                                <textarea v-model="currentStudent.records.specialPerformanceSchool" 
                                          placeholder="è«‹è¼¸å…¥æ ¡å…§ç‰¹æ®Šè¡¨ç¾ç´€éŒ„..." 
                                          class="w-full px-2.5 md:px-3 py-1.5 md:py-2 border-2 border-[#FFE0B2] rounded-xl md:rounded-2xl text-xs md:text-sm resize-none focus:ring-4 focus:ring-[#FFE0B2]/50 focus:border-[#FFB74D] outline-none"
                                          rows="2"></textarea>
                            </div>
                            <div class="bg-white rounded-2xl md:rounded-3xl shadow-sm border-2 border-[#FFCC80] p-3 md:p-6">
                                <label class="text-xs md:text-base font-bold text-[#5D4037] block mb-1.5 md:mb-2">æ ¡å…§å¤–ç‰¹æ®Šè¡¨ç¾ - æ ¡å¤–</label>
                                <textarea v-model="currentStudent.records.specialPerformanceExternal" 
                                          placeholder="è«‹è¼¸å…¥æ ¡å¤–ç‰¹æ®Šè¡¨ç¾ç´€éŒ„..." 
                                          class="w-full px-2.5 md:px-3 py-1.5 md:py-2 border-2 border-[#FFE0B2] rounded-xl md:rounded-2xl text-xs md:text-sm resize-none focus:ring-4 focus:ring-[#FFE0B2]/50 focus:border-[#FFB74D] outline-none"
                                          rows="2"></textarea>
                            </div>
                        </div>
                        <div v-else class="text-center py-8 text-[#8D6E63]">
                            <p>æ­£åœ¨åˆå§‹åŒ–å¤šå…ƒç´€éŒ„...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div v-else class="flex-1 flex flex-col items-center justify-center p-8 text-center bg-[#FFF8F0]">
            <div class="text-7xl md:text-9xl mb-6 cursor-pointer hover:scale-110 transition drop-shadow-lg" @click="isSidebarOpen = true">ğŸ˜º</div>
            <p class="text-xl md:text-2xl font-bold text-[#5D4037] mb-2">æ­¡è¿ä¾†åˆ°å–µå—šè©•èªåŠ©æ‰‹ï¼</p>
            <p class="text-base md:text-lg text-[#8D6E63]">é»æ“Šå·¦ä¸Šè§’é¸å–®ï¼Œé¸æ“‡ä¸€éš»å°è²“å§ ğŸ¾</p>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, reactive, watch, onMounted, computed } = Vue;

    createApp({
        setup() {
            // State
            const isSidebarOpen = ref(false);
            const newGrade = ref('');
            const newClassNum = ref('');
            const showCloudModal = ref(false);
            const gasUrl = ref('');
            const gasSecret = ref(''); // V7.1 è³‡å®‰ï¼šé€šé—œå¯†èª
            const isSyncing = ref(false);
            const syncStatus = ref('');
            const apiKey = ref('');
            const isConfigLoaded = ref(false);
            const isPublicMode = ref(false); // V7.1 è³‡å®‰ï¼šå…¬ç”¨é›»è…¦æ¨¡å¼
            const isGenerating = ref(false);
            const selectedSubject = ref('ä¸€èˆ¬å°å¸«');
            const searchQuery = ref('');
            const showClassManager = ref(false);
            const newClassName = ref('');
            const newClassCount = ref(30);
            const editingClassId = ref(null); // ç·¨è¼¯æ¨¡å¼ï¼šç•¶å‰ç·¨è¼¯çš„ç­ç´š ID
            const db = reactive({ activeClassId: 'default', classes: {} });
            const currentIdx = ref(-1);
            const activeTab = ref('comment');
            const showWelcomeWizard = ref(false); // æ–°æ‰‹å¼•å°ç²¾éˆ
            const wizardStep = ref(1); // å¼•å°æ­¥é©Ÿ 1-3
            const wizardApiKey = ref(''); // å¼•å°ä¸­è¼¸å…¥çš„ API Key
            const tagsDB = {
                'ä¸€èˆ¬å°å¸«': ['ç†±å¿ƒåŠ©äºº', 'è² è²¬ç›¡è·', 'æ´»æ½‘å¤–å‘', 'äººç·£æ¥µä½³', 'æ²‰é»˜å¯¡è¨€', 'å°ˆæ³¨åŠ›ä½³', 'å®¹æ˜“åˆ†å¿ƒ', 'ä½œæ¥­å„ªè‰¯', 'éœ€åŠ å¼·æ•´æ½”', 'ç¦®è²Œå‘¨åˆ°', 'æ„›æƒœå…¬ç‰©', 'æ¨‚æ–¼åˆ†äº«'],
                'åœ‹èªæ–‡': ['å­—è·¡å·¥æ•´', 'å–œæ„›é–±è®€', 'æœ—è®€æµæš¢', 'èªæ„è¡¨é”ä½³', 'æˆèªé‹ç”¨è±å¯Œ', 'å¯«ä½œå…·å‰µæ„', 'å­—éŸ³å­—å½¢éœ€åŠ å¼·'],
                'æ•¸å­¸': ['é‚è¼¯æ¸…æ™°', 'è¨ˆç®—ç´°å¿ƒ', 'ç†è§£åŠ›å¼·', 'è§£é¡Œé€Ÿåº¦å¿«', 'ç²—å¿ƒå¤§æ„', 'ç©ºé–“æ¦‚å¿µä½³', 'é‹ç®—éœ€åŠ å¼·'],
                'è‹±èªæ–‡': ['ç™¼éŸ³æ¨™æº–', 'æ¨‚æ–¼é–‹å£', 'å–®å­—é‡è±å¯Œ', 'è½åŠ›æ•éŠ³', 'å‹‡æ–¼è¡¨é”', 'éœ€åŠ å¼·æ‹¼å­—'],
                'è—è¡“': ['å…·å‚™ç¾æ„Ÿ', 'å¯Œæœ‰å‰µæ„', 'è‰²å½©è±å¯Œ', 'ç·šæ¢å¤§è†½', 'æ­Œè²å„ªç¾', 'ç¯€å¥æ„Ÿå¼·', 'é‘‘è³èƒ½åŠ›ä½³'],
                'å¥åº·èˆ‡é«”è‚²': ['é«”èƒ½å„ªç•°', 'å”èª¿æ€§ä½³', 'åœ˜éšŠåˆä½œ', 'éµå®ˆè¦å‰‡', 'åæ‡‰éˆæ•', 'å±•ç¾é‹å‹•å®¶ç²¾ç¥'],
                'è‡ªç„¶ç§‘å­¸': ['è§€å¯Ÿå…¥å¾®', 'å‹‡æ–¼å¯¦é©—', 'å–œæ„›ç™¼å•', 'é‚è¼¯æ¨æ¼”', 'ç´€éŒ„è©³å¯¦'],
                'ç¤¾æœƒ': ['é—œæ‡·ç’°å¢ƒ', 'å…·å‚™åœ‹éš›è§€', 'å°Šé‡å¤šå…ƒ', 'æ¨‚æ–¼è¨è«–', 'å…·å‚™å…¬æ°‘ç´ é¤Š']
            };
            const MODEL_CANDIDATES = ['gemini-2.0-flash', 'gemini-2.5-flash', 'gemini-2.5-pro', 'gemini-flash-latest'];
            
            // è¡Œç‚ºé‡è¡¨é…ç½®
            const BEHAVIOR_CONFIG = {
                'æ•¬æ„›äºº': {
                    items: [
                        "1.å‹æ„›åŒå­¸ï¼Œå¹«åŠ©ä»–äººï¼Œæ›¿åˆ¥äººè‘—æƒ³",
                        "2.æ¥ç´å’Œå°Šé‡ä¸åŒæ–‡åŒ–çš„äºº",
                        "3.æ„Ÿè¬ç”Ÿæ´»ä¸­ç‚ºæˆ‘å€‘æœå‹™çš„äºº",
                        "4.è®šç¾ä»–äººï¼Œä¸¦å­¸ç¿’ä»–äººçš„é•·è™•",
                        "5.èª å¯¦é¢å°éŒ¯èª¤ï¼Œå‹‡æ–¼æ”¹æ­£"
                    ]
                },
                'æ„›æ•´æ½”': {
                    items: [
                        "1.é£¯å‰ä¾¿å¾Œæ´—æ‰‹ã€é£¯å¾Œæ½”ç‰™æ¼±å£",
                        "2.æ›¸åŒ…ã€æŠ½å±œå’Œæ•™å®¤ä¿æŒæ•´æ½”ï¼Œç‰©æ­¸å®šä½",
                        "3.ä¿æŒå„€å®¹æ•´æ½”ï¼Œå®šæœŸä¿®å‰ªæŒ‡ç”²",
                        "4.åƒåœ¾ä¸è½åœ°ï¼Œç¶­è­·æ ¡åœ’æ•´æ½”",
                        "5.æ­£ç¢ºä½¿ç”¨å»æ‰€ï¼Œä¿æŒæ•´æ½”"
                    ]
                },
                'å®ˆç§©åº': {
                    items: [
                        "1.éµå®ˆæ’éšŠåŠè¡Œé€²ç§©åº",
                        "2.ä¸å–§å˜©ã€å¥”è·‘ã€åšå±éšªå‹•ä½œåŠæ‹¿æ±è¥¿ä¸Ÿäºº",
                        "3.éµå®ˆç”¨é¤ç§©åºï¼Œä¸é‚Šèµ°é‚Šåƒ",
                        "4.æŒ‰æ™‚åˆ°æ ¡ï¼Œä¸Šèª²ä¸é²åˆ°",
                        "5.éµå®ˆå…¬ç‰©ä½¿ç”¨è¦å®šï¼Œä¸éš¨æ„ç ´å£"
                    ]
                },
                'æœ‰ç¦®è²Œ': {
                    items: [
                        "1.æœƒå‘å¸«é•·ã€ä¾†è³“åŠåŒå­¸å•å¥½",
                        "2.å¸¸èªªã€Œè«‹ã€è¬è¬ã€å°ä¸èµ·ã€",
                        "3.ä»”ç´°è†è½åˆ¥äººç™¼è¨€",
                        "4.è¨€è¡Œæœ‰ç¦®ï¼Œè¼•è²ç´°èªã€ä¸èªªç²—æš´çš„è©±",
                        "5.è™›å¿ƒæ¥å—å¸«é•·çš„æŒ‡å°"
                    ]
                },
                'åšç’°ä¿': {
                    items: [
                        "1.åšå¥½åƒåœ¾åˆ†é¡ã€åƒåœ¾æ¸›é‡",
                        "2.æ‡‚å¾—è³‡æºå›æ”¶å†åˆ©ç”¨",
                        "3.å­¸æ ¡åˆé¤ã€æˆ¶å¤–æ´»å‹•æ™‚ï¼Œè‡ªå‚™é¤å…·ç”¨é¤",
                        "4.ç¯€ç´„èƒ½æºï¼Œéš¨æ‰‹é—œç‡ˆã€é—œæ°´é¾é ­",
                        "5.æ„›ç‰©æƒœç‰©ï¼Œä¸æµªè²»è³‡æº"
                    ]
                }
            };
            const BEHAVIOR_OPTIONS = ['å®Œå…¨ç¬¦åˆ', 'å¤§éƒ¨åˆ†ç¬¦åˆ', 'éƒ¨åˆ†ç¬¦åˆ', 'å¾…æ”¹é€²'];

            // Computed
            const currentTags = computed(() => tagsDB[selectedSubject.value] || tagsDB['ä¸€èˆ¬å°å¸«']);
            const currentClassData = computed(() => db.classes[db.activeClassId] || { name: 'æœªçŸ¥ç­ç´š', students: [], grade: '', classNum: '' });
            const filteredStudents = computed(() => {
                const students = currentClassData.value.students || [];
                if (!searchQuery.value) return students.map((s, i) => ({...s, originalIndex: i}));
                return students.map((s, i) => ({...s, originalIndex: i})).filter(s => s.id.includes(searchQuery.value) || s.name.includes(searchQuery.value));
            });
            const students = computed(() => currentClassData.value.students || []);
            const currentStudent = computed(() => {
                if (currentIdx.value === -1) return null;
                const student = students.value[currentIdx.value];
                if (student) initializeStudentData(student);
                return student;
            });

            // å¼·åˆ¶åˆå§‹åŒ–å­¸ç”Ÿè³‡æ–™çµæ§‹
            const initializeStudentData = (student) => {
                if (!student) return;
                
                // ç¢ºä¿ behavior ç‰©ä»¶å­˜åœ¨ä¸”å®Œæ•´
                if (!student.behavior) {
                    student.behavior = {};
                }
                Object.keys(BEHAVIOR_CONFIG).forEach(category => {
                    if (!student.behavior[category]) {
                        student.behavior[category] = {
                            items: BEHAVIOR_CONFIG[category].items.map(() => ''),
                            suggestion: ''
                        };
                    } else {
                        // ç¢ºä¿ items é™£åˆ—é•·åº¦æ­£ç¢º
                        if (!student.behavior[category].items || student.behavior[category].items.length !== BEHAVIOR_CONFIG[category].items.length) {
                            student.behavior[category].items = BEHAVIOR_CONFIG[category].items.map(() => '');
                        }
                        // ç¢ºä¿ suggestion å­˜åœ¨
                        if (student.behavior[category].suggestion === undefined) {
                            student.behavior[category].suggestion = '';
                        }
                    }
                });
                
                // ç¢ºä¿ records ç‰©ä»¶å­˜åœ¨ä¸”å®Œæ•´
                if (!student.records) {
                    student.records = {
                        groupActivity: '',
                        publicServiceSchool: '',
                        publicServiceCommunity: '',
                        specialPerformanceSchool: '',
                        specialPerformanceExternal: ''
                    };
                } else {
                    // ç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½å­˜åœ¨
                    if (student.records.groupActivity === undefined) student.records.groupActivity = '';
                    if (student.records.publicServiceSchool === undefined) student.records.publicServiceSchool = '';
                    if (student.records.publicServiceCommunity === undefined) student.records.publicServiceCommunity = '';
                    if (student.records.specialPerformanceSchool === undefined) student.records.specialPerformanceSchool = '';
                    if (student.records.specialPerformanceExternal === undefined) student.records.specialPerformanceExternal = '';
                }
                
                return student;
            };

            onMounted(() => {
                if (window.APP_CONFIG) {
                    if (window.APP_CONFIG.GEMINI_API_KEY) { apiKey.value = window.APP_CONFIG.GEMINI_API_KEY; isConfigLoaded.value = true; }
                    if (window.APP_CONFIG.GAS_URL) { gasUrl.value = window.APP_CONFIG.GAS_URL; }
                } else {
                    const savedKey = localStorage.getItem('gemini_api_key');
                    if (savedKey) {
                        apiKey.value = savedKey;
                    } else {
                        // æ²’æœ‰ API Keyï¼Œé¡¯ç¤ºæ–°æ‰‹å¼•å°
                        showWelcomeWizard.value = true;
                    }
                    const savedGas = localStorage.getItem('gemini_gas_url');
                    if (savedGas) gasUrl.value = savedGas;
                    const savedSecret = localStorage.getItem('gas_secret');
                    if (savedSecret) gasSecret.value = savedSecret;
                }
                const savedDB = localStorage.getItem('gemini_comments_v4_db');
                if (savedDB) {
                    const parsed = JSON.parse(savedDB);
                    Object.keys(parsed.classes || {}).forEach(classId => {
                        if (parsed.classes[classId].students) {
                            parsed.classes[classId].students.forEach(initializeStudentData);
                        }
                    });
                    Object.assign(db, parsed);
                    db.activeClassId = db.activeClassId; // è§¸ç™¼ reactive æ›´æ–°
                } else {
                    showClassManager.value = true;
                }
            });

            // æ–°æ‰‹å¼•å°æ–¹æ³•
            const nextWizardStep = () => {
                if (wizardStep.value < 3) wizardStep.value++;
            };
            const prevWizardStep = () => {
                if (wizardStep.value > 1) wizardStep.value--;
            };
            const completeWizard = () => {
                if (wizardApiKey.value.trim()) {
                    apiKey.value = wizardApiKey.value.trim();
                    localStorage.setItem('gemini_api_key', apiKey.value);
                }
                showWelcomeWizard.value = false;
                wizardStep.value = 1;
                wizardApiKey.value = '';
            };
            const skipWizard = () => {
                showWelcomeWizard.value = false;
                wizardStep.value = 1;
                wizardApiKey.value = '';
            };
            const openWizard = () => {
                wizardStep.value = 1;
                wizardApiKey.value = '';
                showWelcomeWizard.value = true;
            };

            watch(db, (newVal) => localStorage.setItem('gemini_comments_v4_db', JSON.stringify(newVal)), { deep: true });
            // V7.1 è³‡å®‰ï¼šå…¬ç”¨é›»è…¦æ¨¡å¼ä¸‹ä¸å„²å­˜ API Key
            watch(apiKey, (newVal) => { 
                if (!isConfigLoaded.value && !isPublicMode.value) {
                    localStorage.setItem('gemini_api_key', newVal); 
                }
            });
            watch(gasUrl, (newVal) => localStorage.setItem('gemini_gas_url', newVal));
            watch(gasSecret, (newVal) => localStorage.setItem('gas_secret', newVal)); // V7.1 è³‡å®‰

            // Methods
            const selectStudent = (index) => {
                currentIdx.value = index;
                isSidebarOpen.value = false; // æ‰‹æ©Ÿç‰ˆï¼šé¸æ“‡å­¸ç”Ÿå¾Œè‡ªå‹•æ”¶èµ·å´é‚Šæ¬„
            };

            const uploadToCloud = async () => {
                isSyncing.value = true; syncStatus.value = 'â˜ï¸ ä¸Šå‚³ä¸­...';
                try {
                    // V7.1 è³‡å®‰ï¼šå°‡ secret èˆ‡ data ä¸€èµ·æ‰“åŒ…å‚³é€
                    const payload = {
                        secret: gasSecret.value || 'meow1234', // é è¨­å¯†èª
                        data: db
                    };
                    const response = await fetch(gasUrl.value, { method: 'POST', body: JSON.stringify(payload) });
                    const res = await response.json();
                    if (res.result === 'success') syncStatus.value = `âœ… æˆåŠŸ! (${new Date().toLocaleTimeString()})`;
                    else throw new Error(res.message || res.error || 'é©—è­‰å¤±æ•—');
                } catch (e) { syncStatus.value = 'âŒ å¤±æ•—:' + e.message; } finally { isSyncing.value = false; }
            };
            const downloadFromCloud = async () => {
                if (!confirm('è¦†è“‹æœ¬æ©Ÿè³‡æ–™ï¼Ÿ')) return;
                isSyncing.value = true; syncStatus.value = 'â˜ï¸ ä¸‹è¼‰ä¸­...';
                try {
                    const response = await fetch(gasUrl.value);
                    const cloudData = await response.json();
                    if (cloudData && cloudData.classes) { Object.assign(db, cloudData); syncStatus.value = `âœ… é‚„åŸæˆåŠŸï¼`; currentIdx.value = -1; showClassManager.value = true; }
                    else throw new Error('è³‡æ–™éŒ¯èª¤');
                } catch (e) { syncStatus.value = 'âŒ å¤±æ•—:' + e.message; } finally { isSyncing.value = false; }
            };

            // åˆå§‹åŒ–å­¸ç”Ÿè¡Œç‚ºè³‡æ–™çµæ§‹
            const initStudentBehavior = () => {
                const behavior = {};
                const records = {
                    groupActivity: '',
                    publicServiceSchool: '',
                    publicServiceCommunity: '',
                    specialPerformanceSchool: '',
                    specialPerformanceExternal: ''
                };
                Object.keys(BEHAVIOR_CONFIG).forEach(category => {
                    behavior[category] = {
                        items: BEHAVIOR_CONFIG[category].items.map(() => ''),
                        suggestion: ''
                    };
                });
                return { behavior, records };
            };

            const createNewClass = () => {
                if (!newGrade.value || !newClassNum.value) { alert('è«‹è¼¸å…¥å¹´ç´šèˆ‡ç­ç´š'); return; }
                const newId = 'class_' + Date.now();
                const newStudents = Array.from({length: newClassCount.value}, (_, i) => {
                    const { behavior, records } = initStudentBehavior();
                    const student = {
                        id: String(i+1).padStart(2,'0'), name:'', raw_comment:'', polished_comment:'', motto:'',
                        behavior, records
                    };
                    initializeStudentData(student);
                    return student;
                });
                db.classes[newId] = { 
                    name: newClassName.value || `${newGrade.value}å¹´${newClassNum.value}ç­`, 
                    grade: String(newGrade.value), classNum: String(newClassNum.value), students: newStudents 
                };
                switchClass(newId); 
                cancelEdit();
            };
            
            const editClass = (id) => {
                const cls = db.classes[id];
                if (!cls) return;
                editingClassId.value = id;
                newGrade.value = cls.grade || '';
                newClassNum.value = cls.classNum || '';
                newClassName.value = cls.name || '';
            };
            
            const updateClass = () => {
                if (!editingClassId.value) return;
                if (!newGrade.value || !newClassNum.value) { alert('è«‹è¼¸å…¥å¹´ç´šèˆ‡ç­ç´š'); return; }
                const cls = db.classes[editingClassId.value];
                if (cls) {
                    cls.grade = String(newGrade.value);
                    cls.classNum = String(newClassNum.value);
                    cls.name = newClassName.value || `${newGrade.value}å¹´${newClassNum.value}ç­`;
                    
                    // å¦‚æœç­ç´šå­¸ç”Ÿæ•¸ç‚º 0ï¼Œå‰‡æ ¹æ“šè¼¸å…¥çš„äººæ•¸é‡æ–°å»ºç«‹å­¸ç”Ÿ
                    if (cls.students.length === 0 && newClassCount.value > 0) {
                        cls.students = Array.from({length: newClassCount.value}, (_, i) => {
                            const { behavior, records } = initStudentBehavior();
                            const student = {
                                id: String(i+1).padStart(2,'0'), name:'', raw_comment:'', polished_comment:'', motto:'',
                                behavior, records
                            };
                            initializeStudentData(student);
                            return student;
                        });
                    }
                }
                cancelEdit();
            };
            
            const cancelEdit = () => {
                editingClassId.value = null;
                newClassName.value = '';
                newGrade.value = '';
                newClassNum.value = '';
            };
            const switchClass = (id) => { db.activeClassId = id; currentIdx.value = -1; isSidebarOpen.value = false; }; // åˆ‡æ›ç­ç´šå¾Œé—œé–‰é¸å–®
            const deleteClass = (id) => { if (Object.keys(db.classes).length <= 1) return; if(confirm('åˆªé™¤ï¼Ÿ')) { delete db.classes[id]; if (db.activeClassId === id) { db.activeClassId = Object.keys(db.classes)[0]; currentIdx.value = -1; } } };
            
            const handleImportExcel = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const wb = XLSX.read(evt.target.result, { type: 'binary' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    // V6.0: ä½¿ç”¨ç´¢å¼•å®šä½æ–¹å¼è®€å–é›™å±¤è¡¨é ­ Excel
                    const data = XLSX.utils.sheet_to_json(ws, { header: 1 }); // è®€å–ç‚ºé™£åˆ—çš„é™£åˆ—
                    
                    if (data.length < 3) {
                        alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼šè³‡æ–™ä¸è¶³');
                        return;
                    }
                    
                    // è·³éå‰å…©åˆ— (Row 0, Row 1 ç‚ºæ¨™é¡Œ)ï¼Œå¾ Row 2 é–‹å§‹
                    const studentRows = data.slice(2);
                    let detectedGrade = '';
                    let detectedClassNum = '';
                    
                    // å¾ç¬¬ä¸€ç­†è³‡æ–™è‡ªå‹•åµæ¸¬å¹´ç´šèˆ‡ç­åº
                    if (studentRows.length > 0 && studentRows[0][0]) {
                        detectedGrade = String(studentRows[0][0]);
                    }
                    if (studentRows.length > 0 && studentRows[0][1]) {
                        detectedClassNum = String(studentRows[0][1]);
                    }
                    
                    const categories = ['æ•¬æ„›äºº', 'æ„›æ•´æ½”', 'å®ˆç§©åº', 'æœ‰ç¦®è²Œ', 'åšç’°ä¿'];
                    const categoryOffsets = [4, 10, 16, 22, 28]; // æ¯å¤§é¡çš„èµ·å§‹ç´¢å¼•
                    
                    const importedStudents = studentRows.map((row, rowIdx) => {
                        if (!row || row.length === 0) return null; // è·³éç©ºè¡Œ
                        
                        const { behavior, records } = initStudentBehavior();
                        
                        // åŸºæœ¬è³‡æ–™ (ç´¢å¼• 0-3)
                        const grade = row[0] ? String(row[0]) : '';
                        const classNum = row[1] ? String(row[1]) : '';
                        const id = row[2] ? String(Math.floor(parseFloat(row[2]))).padStart(2, '0') : String(rowIdx + 1).padStart(2, '0');
                        const name = row[3] ? String(row[3]) : '';
                        
                        // 5 å¤§é¡è¡Œç‚ºæŒ‡æ¨™ (æ¯é¡ 5 å€‹å­é¡Œ + 1 å€‹å»ºè­°)
                        categories.forEach((category, catIdx) => {
                            const offset = categoryOffsets[catIdx];
                            // 5 å€‹å­é¡Œ (ç´¢å¼• offset åˆ° offset+4)
                            for (let i = 0; i < 5; i++) {
                                if (row[offset + i] !== undefined && row[offset + i] !== null && row[offset + i] !== '') {
                                    behavior[category].items[i] = String(row[offset + i]);
                                }
                            }
                            // å…·é«”å»ºè­° (ç´¢å¼• offset+5)
                            if (row[offset + 5] !== undefined && row[offset + 5] !== null && row[offset + 5] !== '') {
                                behavior[category].suggestion = String(row[offset + 5]);
                            }
                        });
                        
                        // å¤šå…ƒç´€éŒ„
                        if (row[34] !== undefined && row[34] !== null && row[34] !== '') records.groupActivity = String(row[34]);
                        if (row[35] !== undefined && row[35] !== null && row[35] !== '') records.publicServiceSchool = String(row[35]);
                        if (row[36] !== undefined && row[36] !== null && row[36] !== '') records.publicServiceCommunity = String(row[36]);
                        if (row[37] !== undefined && row[37] !== null && row[37] !== '') records.specialPerformanceSchool = String(row[37]);
                        if (row[38] !== undefined && row[38] !== null && row[38] !== '') records.specialPerformanceExternal = String(row[38]);
                        
                        // è©•èª (ç´¢å¼• 39, 40)
                        const polished_comment = row[39] ? String(row[39]) : '';
                        const motto = row[40] ? String(row[40]) : '';
                        
                        const student = {
                            id, name, polished_comment, motto, raw_comment: '', behavior, records
                        };
                        initializeStudentData(student);
                        return student;
                    }).filter(s => s !== null); // éæ¿¾ç©ºè¡Œ
                    
                    const newId = 'class_import_' + Date.now();
                    let className = file.name.replace(/\.[^/.]+$/, "");
                    if (detectedGrade && detectedClassNum) {
                        className = `${detectedGrade}å¹´${detectedClassNum}ç­ (åŒ¯å…¥)`;
                    }
                    db.classes[newId] = { name: className, grade: detectedGrade, classNum: detectedClassNum, students: importedStudents };
                    switchClass(newId); 
                    showClassManager.value = false;
                    alert(detectedGrade && detectedClassNum ? `åŒ¯å…¥æˆåŠŸï¼${detectedGrade}å¹´${detectedClassNum}ç­ï¼Œå…± ${importedStudents.length} ä½å­¸ç”Ÿã€‚` : 'åŒ¯å…¥æˆåŠŸï¼è«‹æ‰‹å‹•è¨­å®šå¹´ç´šèˆ‡ç­åºã€‚');
                };
                reader.readAsBinaryString(file); 
                e.target.value = '';
            };
            
            const resetCurrentClass = () => { if(confirm('æ¸…ç©ºï¼Ÿ')) { db.classes[db.activeClassId].students = []; currentIdx.value = -1; } };
            const addTag = (tag) => { if (currentStudent.value) currentStudent.value.raw_comment += (currentStudent.value.raw_comment ? 'ã€' : '') + tag; };
            
            // ä¸€éµé è¨­è¡Œç‚ºé‡è¡¨
            const setDefaultBehavior = () => {
                if (!currentStudent.value) return;
                initializeStudentData(currentStudent.value);
                Object.keys(BEHAVIOR_CONFIG).forEach(category => {
                    BEHAVIOR_CONFIG[category].items.forEach((_, idx) => {
                        currentStudent.value.behavior[category].items[idx] = 'å¤§éƒ¨åˆ†ç¬¦åˆ';
                    });
                });
                db.activeClassId = db.activeClassId; // è§¸ç™¼æ›´æ–°
            };

            // ä¿®æ­£å¾Œçš„ generateComment å‡½å¼æ ¸å¿ƒ
            const generateComment = async () => {
                // 1. åŸºç¤é˜²å‘†
                if (!apiKey.value) { alert('è«‹è¼¸å…¥ Key'); return; }
                if (!currentStudent.value.name) { alert('è«‹è¼¸å…¥å§“å'); return; }
                if (!currentStudent.value.raw_comment) { alert('è«‹è¼¸å…¥ç´€éŒ„'); return; }
                
                // 2. è¨­å®šç‹€æ…‹èˆ‡é€¾æ™‚æ§åˆ¶å™¨
                isGenerating.value = true;
                currentStudent.value.polished_comment = "ğŸ¾ è²“è²“æ€è€ƒä¸­...";
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ç§’é€¾æ™‚è¨­å®š

                // 3. ç²¾å¿ƒè¨­è¨ˆçš„ Prompt (åˆ‡å‹¿ç²¾ç°¡æ­¤æ®µ)
                const prompt = `
                    è§’è‰²è¨­å®šï¼šä½ æ˜¯ä¸€ä½è³‡æ·±çš„å°ç£åœ‹å°å°å¸«ï¼Œæ“…é•·ç­ç´šç¶“ç‡Ÿèˆ‡è¦ªå¸«æºé€šï¼Œæ–‡å­—å¯Œæœ‰æº«åº¦ä¸”ç²¾æº–ã€‚
                    
                    ä»»å‹™ç›®æ¨™ï¼šè«‹æ ¹æ“šä»¥ä¸‹ã€Œè§€å¯Ÿç´€éŒ„ã€ï¼Œç‚ºå­¸ç”Ÿã€Œ${currentStudent.value.name}ã€æ’°å¯«å…©ä»½é¢¨æ ¼æˆªç„¶ä¸åŒçš„è©•èªã€‚
                    
                    è¼¸å…¥è³‡æ–™ï¼š
                    - å­¸ç”Ÿå§“åï¼š${currentStudent.value.name}
                    - è§€å¯Ÿç´€éŒ„ï¼š${currentStudent.value.raw_comment}
                    
                    è¼¸å‡ºæ ¼å¼ï¼šè«‹åƒ…è¼¸å‡ºä¸€å€‹åˆæ³•çš„ JSON ç‰©ä»¶ (ä¸è¦æœ‰ markdown æ¨™è¨˜)ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
                    {
                        "comment": "å­¸æœŸæˆç¸¾å–®è©•èª (çµ¦å®¶é•·çœ‹)",
                        "motto": "å­¸ç±å¡å…«å­—ç®´è¨€ (çµ¦æ ¡æ–¹å­˜æª”)"
                    }
                    
                    æ’°å¯«è¦å‰‡ï¼š
                    1. comment (æˆç¸¾å–®è©•èª)ï¼š
                       - é¢¨æ ¼ï¼šæº«æš–ã€æ­£å‘ã€é¼“å‹µã€æˆé•·å‹æ€ç¶­ (Growth Mindset)ã€‚
                       - çµæ§‹ï¼šæ¡ç”¨ã€Œä¸‰æ˜æ²»æ³•ã€ï¼ˆå…ˆè‚¯å®šå„ªé» -> æº«å’Œæå‡ºå»ºè­° -> çµ¦äºˆæ­£å‘æœŸè¨±ï¼‰ã€‚
                       - å­—æ•¸ï¼šæ§åˆ¶åœ¨ 70 ~ 100 å­—ä¹‹é–“ã€‚
                       - èªæ°£ï¼šè®“å®¶é•·æ„Ÿåˆ°å®‰å¿ƒï¼Œå³ä½¿æœ‰ç¼ºé»ï¼Œä¹Ÿè¦ç”¨ã€ŒæœŸè¨±ã€çš„æ–¹å¼è¡¨é” (ä¾‹å¦‚å°‡ã€Œæ„›è¬›è©±ã€è½‰åŒ–ç‚ºã€Œå–„æ–¼è¡¨é”ï¼Œè‹¥èƒ½çœ‹å ´åˆç™¼è¨€æœƒæ›´æ£’ã€)ã€‚
                    
                    2. motto (å…«å­—ç®´è¨€)ï¼š
                       - é¢¨æ ¼ï¼šä¸­ç«‹ã€å®¢è§€ã€åš´è¬¹ã€ç°¡æ½”ã€‚
                       - æ ¼å¼ï¼šåš´æ ¼é™åˆ¶ç‚ºã€Œå…©å€‹å››å­—è©èªã€ï¼Œä¸­é–“ç”¨å…¨å½¢é€—è™Ÿã€Œï¼Œã€éš”é–‹ã€‚
                       - é‚è¼¯åˆ¤æ–· (å¿…éµå®ˆ)ï¼š
                         (A) è‹¥è§€å¯Ÿç´€éŒ„ã€å…¨ç‚ºå„ªé»ã€‘ï¼šçµ¦äºˆå…©å€‹æ­£å‘è©èª (å¦‚ï¼šå“å­¸å…¼å„ªï¼Œç†±å¿ƒåŠ©äºº)ã€‚
                         (B) è‹¥è§€å¯Ÿç´€éŒ„ã€å¥½å£åƒåŠã€‘ï¼šçµ¦äºˆä¸€å€‹å„ªé» + ä¸€å€‹æé†’ (å¦‚ï¼šæ´»æ½‘å¥½å‹•ï¼Œéœ€å®ˆç§©åº)ã€‚
                         (C) è‹¥è§€å¯Ÿç´€éŒ„ã€å¤šç‚ºç¼ºé»ã€‘ï¼šçµ¦äºˆå…©å€‹æ”¹é€²å»ºè­°æˆ–æé†’ (å¦‚ï¼šåŠ å¼·å°ˆæ³¨ï¼Œæ”¹é€²å¸¸è¦)ã€‚
                `;
                
                // 4. API å‘¼å« (åŒ…å«éŒ¯èª¤è™•ç†èˆ‡é‡è©¦é‚è¼¯)
                let success = false;
                for (const model of MODEL_CANDIDATES) {
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey.value}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                            signal: controller.signal // ç¶å®šé€¾æ™‚è¨Šè™Ÿ
                        });
                        
                        const data = await res.json();
                        if (data.candidates) {
                            let text = data.candidates[0].content.parts[0].text
                                .replace(/```json/g, '')
                                .replace(/```/g, '')
                                .trim();
                            const result = JSON.parse(text);
                            
                            // æ›´æ–°è³‡æ–™
                            currentStudent.value.polished_comment = result.comment; 
                            currentStudent.value.motto = result.motto;
                            success = true;
                            break; // æˆåŠŸå‰‡è·³å‡ºè¿´åœˆ
                        }
                    } catch (e) {
                        // è‹¥æ˜¯é€¾æ™‚éŒ¯èª¤ï¼Œå¯ä»¥åœ¨æ­¤è™•è¨˜éŒ„ï¼Œæˆ–è®“è¿´åœˆç¹¼çºŒå˜—è©¦ä¸‹ä¸€å€‹æ¨¡å‹
                        if (e.name === 'AbortError') console.warn(`Model ${model} timed out.`);
                    }
                }
                
                // 5. æ”¶å°¾èˆ‡ç‹€æ…‹é‡ç½®
                clearTimeout(timeoutId); // æ¸…é™¤è¨ˆæ™‚å™¨
                if (!success) {
                    currentStudent.value.polished_comment = "âŒ ç”Ÿæˆå¤±æ•—æˆ–é€£ç·šé€¾æ™‚ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚";
                    alert('è²“è²“æƒ³å¤ªä¹…äº†(è¶…é15ç§’)æˆ–æ˜¯ç¶²è·¯ä¸ç©©ï¼Œè«‹å†æŒ‰ä¸€æ¬¡ã€Œå¹«æˆ‘å¯«ã€ï¼');
                }
                isGenerating.value = false;
            };

            // V7.1 è³‡å®‰ï¼šExcel Formula Injection é˜²è­·
            const sanitizeForExcel = (value) => {
                if (typeof value !== 'string') return value;
                // è‹¥å­—ä¸²ä»¥ =, +, -, @ é–‹é ­ï¼ŒåŠ ä¸Šå–®å¼•è™Ÿé˜²æ­¢å…¬å¼åŸ·è¡Œ
                if (/^[=+\-@]/.test(value)) return "'" + value;
                return value;
            };
            
            const exportToExcel = () => {
                JSON.stringify(db); // è§¸ç™¼ reactive æ›´æ–°
                const cls = currentClassData.value;
                const grade = cls.grade || 'æœªè¨­å®š'; 
                const classNum = cls.classNum || 'æœªè¨­å®š';
                
                // åˆå§‹åŒ–æ‰€æœ‰å­¸ç”Ÿè³‡æ–™
                const processedStudents = students.value.map(s => {
                    initializeStudentData(s);
                    return s;
                });
                
                // å»ºç«‹é›™å±¤è¡¨é ­é™£åˆ—
                const ws_data = [];
                
                // Row 0: å¤§åˆ†é¡è¡¨é ­
                const row0 = [
                    'â€»å¹´ç´š', 'â€»ç­ç´šç·¨è™Ÿ', 'â€»åº§è™Ÿ', 'â€»å§“å',  // Col A-D (0-3)
                    'â€»æ•¬æ„›äºº', '', '', '', '', '',  // Col E-J (4-9)
                    'â€»æ„›æ•´æ½”', '', '', '', '', '',  // Col K-P (10-15)
                    'â€»å®ˆç§©åº', '', '', '', '', '',  // Col Q-V (16-21)
                    'â€»æœ‰ç¦®è²Œ', '', '', '', '', '',  // Col W-AB (22-27)
                    'â€»åšç’°ä¿', '', '', '', '', '',  // Col AC-AH (28-33)
                    'åœ˜é«”æ´»å‹•ç´€éŒ„',  // Col AI (34)
                    'å…¬å…±æœå‹™ç´€éŒ„', '',  // Col AJ-AK (35-36)
                    'æ ¡å…§å¤–ç‰¹æ®Šè¡¨ç¾ç´€éŒ„', '',  // Col AL-AM (37-38)
                    'å­¸æœŸæˆç¸¾å–®å°å¸«è©•èª',  // Col AN (39)
                    'å­¸ç±å¡å°å¸«è©•èª'  // Col AO (40)
                ];
                ws_data.push(row0);
                
                // Row 1: å­é …ç›®è¡¨é ­
                const row1 = [
                    '', '', '', '',  // Col A-D ç•™ç©ºï¼ˆå‚ç›´åˆä½µï¼‰
                ];
                
                // 5 å¤§é¡è¡Œç‚ºæŒ‡æ¨™å­é …ç›®
                Object.keys(BEHAVIOR_CONFIG).forEach(category => {
                    BEHAVIOR_CONFIG[category].items.forEach(item => row1.push(item));
                    row1.push('å…·é«”å»ºè­°');
                });
                
                // å¤šå…ƒç´€éŒ„å­é …ç›®
                row1.push('');  // Col AI (34) åœ˜é«”æ´»å‹•ç´€éŒ„ç•™ç©ºï¼ˆå‚ç›´åˆä½µï¼‰
                row1.push('æ ¡å…§æœå‹™');  // Col AJ (35)
                row1.push('ç¤¾å€æœå‹™');  // Col AK (36)
                row1.push('æ ¡å…§ç‰¹æ®Šè¡¨ç¾');  // Col AL (37)
                row1.push('æ ¡å¤–ç‰¹æ®Šè¡¨ç¾');  // Col AM (38)
                row1.push('');  // Col AN (39) å­¸æœŸæˆç¸¾å–®å°å¸«è©•èªç•™ç©ºï¼ˆå‚ç›´åˆä½µï¼‰
                row1.push('');  // Col AO (40) å­¸ç±å¡å°å¸«è©•èªç•™ç©ºï¼ˆå‚ç›´åˆä½µï¼‰
                
                ws_data.push(row1);
                
                // Row 2+: å­¸ç”Ÿè³‡æ–™ (V7.1 è³‡å®‰ï¼šæ‰€æœ‰å­—ä¸²æ¬„ä½ç¶“éæ¶ˆæ¯’è™•ç†)
                processedStudents.forEach(s => {
                    const studentRow = [
                        grade,  // Col A: å¹´ç´š
                        classNum,  // Col B: ç­ç´šç·¨è™Ÿ
                        parseInt(s.id, 10) || 0,  // Col C: åº§è™Ÿ
                        sanitizeForExcel(s.name || '')  // Col D: å§“å
                    ];
                    
                    // 5 å¤§é¡è¡Œç‚ºæŒ‡æ¨™ï¼ˆæ¯é¡ 5 å€‹å­é¡Œ + 1 å€‹å…·é«”å»ºè­°ï¼‰
                    const categories = ['æ•¬æ„›äºº', 'æ„›æ•´æ½”', 'å®ˆç§©åº', 'æœ‰ç¦®è²Œ', 'åšç’°ä¿'];
                    categories.forEach(category => {
                        BEHAVIOR_CONFIG[category].items.forEach((_, idx) => {
                            studentRow.push(sanitizeForExcel((s.behavior[category] && s.behavior[category].items[idx]) || ''));
                        });
                        studentRow.push(sanitizeForExcel((s.behavior[category] && s.behavior[category].suggestion) || ''));
                    });
                    
                    // å¤šå…ƒç´€éŒ„
                    studentRow.push(sanitizeForExcel(s.records.groupActivity || ''));  // Col AI: åœ˜é«”æ´»å‹•ç´€éŒ„
                    studentRow.push(sanitizeForExcel(s.records.publicServiceSchool || ''));  // Col AJ: æ ¡å…§æœå‹™
                    studentRow.push(sanitizeForExcel(s.records.publicServiceCommunity || ''));  // Col AK: ç¤¾å€æœå‹™
                    studentRow.push(sanitizeForExcel(s.records.specialPerformanceSchool || ''));  // Col AL: æ ¡å…§ç‰¹æ®Šè¡¨ç¾
                    studentRow.push(sanitizeForExcel(s.records.specialPerformanceExternal || ''));  // Col AM: æ ¡å¤–ç‰¹æ®Šè¡¨ç¾
                    
                    // è©•èª
                    studentRow.push(sanitizeForExcel(s.polished_comment || ''));  // Col AN: å­¸æœŸæˆç¸¾å–®å°å¸«è©•èª
                    studentRow.push(sanitizeForExcel(s.motto || ''));  // Col AO: å­¸ç±å¡å°å¸«è©•èª
                    
                    ws_data.push(studentRow);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                
                // è¨­å®šåˆä½µå„²å­˜æ ¼
                ws['!merges'] = [
                    // å‚ç›´åˆä½µ Row 0-1: åŸºæœ¬è³‡æ–™ (Col A-D)
                    { s: { r: 0, c: 0 }, e: { r: 1, c: 0 } },  // å¹´ç´š
                    { s: { r: 0, c: 1 }, e: { r: 1, c: 1 } },  // ç­ç´šç·¨è™Ÿ
                    { s: { r: 0, c: 2 }, e: { r: 1, c: 2 } },  // åº§è™Ÿ
                    { s: { r: 0, c: 3 }, e: { r: 1, c: 3 } },  // å§“å
                    
                    // æ°´å¹³åˆä½µ Row 0: æ•¬æ„›äºº (Col E-J, ç´¢å¼•4-9)
                    { s: { r: 0, c: 4 }, e: { r: 0, c: 9 } },
                    // æ°´å¹³åˆä½µ Row 0: æ„›æ•´æ½” (Col K-P, ç´¢å¼•10-15)
                    { s: { r: 0, c: 10 }, e: { r: 0, c: 15 } },
                    // æ°´å¹³åˆä½µ Row 0: å®ˆç§©åº (Col Q-V, ç´¢å¼•16-21)
                    { s: { r: 0, c: 16 }, e: { r: 0, c: 21 } },
                    // æ°´å¹³åˆä½µ Row 0: æœ‰ç¦®è²Œ (Col W-AB, ç´¢å¼•22-27)
                    { s: { r: 0, c: 22 }, e: { r: 0, c: 27 } },
                    // æ°´å¹³åˆä½µ Row 0: åšç’°ä¿ (Col AC-AH, ç´¢å¼•28-33)
                    { s: { r: 0, c: 28 }, e: { r: 0, c: 33 } },
                    
                    // å‚ç›´åˆä½µ Row 0-1: åœ˜é«”æ´»å‹•ç´€éŒ„ (Col AI, ç´¢å¼•34)
                    { s: { r: 0, c: 34 }, e: { r: 1, c: 34 } },
                    
                    // æ°´å¹³åˆä½µ Row 0: å…¬å…±æœå‹™ç´€éŒ„ (Col AJ-AK, ç´¢å¼•35-36)
                    { s: { r: 0, c: 35 }, e: { r: 0, c: 36 } },
                    // æ°´å¹³åˆä½µ Row 0: æ ¡å…§å¤–ç‰¹æ®Šè¡¨ç¾ç´€éŒ„ (Col AL-AM, ç´¢å¼•37-38)
                    { s: { r: 0, c: 37 }, e: { r: 0, c: 38 } },
                    
                    // å‚ç›´åˆä½µ Row 0-1: å­¸æœŸæˆç¸¾å–®å°å¸«è©•èª (Col AN, ç´¢å¼•39)
                    { s: { r: 0, c: 39 }, e: { r: 1, c: 39 } },
                    // å‚ç›´åˆä½µ Row 0-1: å­¸ç±å¡å°å¸«è©•èª (Col AO, ç´¢å¼•40)
                    { s: { r: 0, c: 40 }, e: { r: 1, c: 40 } }
                ];
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "æ—¥å¸¸è¡¨ç¾èˆ‡å°å¸«è©•èª");
                XLSX.writeFile(wb, `æ—¥å¸¸è¡Œç‚ºè¡¨ç¾èˆ‡å°å¸«è©•èªåŒ¯å…¥æª”(${grade}0${classNum}).xlsx`);
            };
            const copyResult = () => navigator.clipboard.writeText(currentStudent.value.polished_comment);
            
            // è¤‡è£½ GAS ç¨‹å¼ç¢¼ (V7.1 å«é©—è­‰æ©Ÿåˆ¶)
            const gasCode = `// âš ï¸ è«‹å°‡ä¸‹æ–¹ "meow1234" æ”¹ç‚ºè‡ªè¨‚å¯†èªï¼
var SECRET = "meow1234";

function doPost(e) {
  var payload = JSON.parse(e.postData.contents);
  // é©—è­‰é€šé—œå¯†èª
  if (payload.secret !== SECRET) {
    return ContentService.createTextOutput(JSON.stringify({"result":"error","message":"å¯†èªéŒ¯èª¤"})).setMimeType(ContentService.MimeType.JSON);
  }
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  sheet.getRange("A1").setValue(JSON.stringify(payload.data));
  return ContentService.createTextOutput(JSON.stringify({"result":"success"})).setMimeType(ContentService.MimeType.JSON);
}
function doGet(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = sheet.getRange("A1").getValue();
  return ContentService.createTextOutput(data).setMimeType(ContentService.MimeType.JSON);
}`;
            const copyGasCode = () => {
                navigator.clipboard.writeText(gasCode);
                alert('âœ… ç¨‹å¼ç¢¼å·²è¤‡è£½ï¼è«‹å‰å¾€ Google Apps Script è²¼ä¸Šã€‚');
            };
            
            // V7.1 è³‡å®‰ï¼šä¸€éµæ¸…é™¤æ‰€æœ‰æ•æ„Ÿè³‡æ–™
            const clearAllData = () => {
                if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ•æ„Ÿè³‡æ–™å—ï¼Ÿ\n\nå°‡æœƒæ¸…é™¤ï¼š\nâ€¢ API Key\nâ€¢ GAS ç¶²å€\nâ€¢ é€šé—œå¯†èª\n\nç­ç´šè³‡æ–™ä¸æœƒå—åˆ°å½±éŸ¿ã€‚')) return;
                localStorage.removeItem('gemini_api_key');
                localStorage.removeItem('gemini_gas_url');
                localStorage.removeItem('gas_secret');
                alert('âœ… æ•æ„Ÿè³‡æ–™å·²æ¸…é™¤ï¼é é¢å°‡é‡æ–°æ•´ç†ã€‚');
                location.reload();
            };

            return { 
                apiKey, isConfigLoaded, isPublicMode, students, currentIdx, currentStudent, isGenerating, searchQuery, filteredStudents, selectedSubject, currentTags, 
                db, showClassManager, newClassName, newClassCount, currentClassData, showCloudModal, gasUrl, gasSecret, isSyncing, syncStatus,
                newGrade, newClassNum, isSidebarOpen, activeTab,
                BEHAVIOR_CONFIG, BEHAVIOR_OPTIONS,
                createNewClass, editClass, updateClass, cancelEdit, switchClass, deleteClass, handleImportExcel, resetCurrentClass, selectStudent, addTag, generateComment, exportToExcel, copyResult, copyGasCode, clearAllData, uploadToCloud, downloadFromCloud,
                setDefaultBehavior, editingClassId,
                showWelcomeWizard, wizardStep, wizardApiKey, nextWizardStep, prevWizardStep, completeWizard, skipWizard, openWizard
            };
        }
    }).mount('#app');
</script>
</body>
</html>